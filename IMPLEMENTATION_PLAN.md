# MoniWorks Implementation Plan

## Current Status
- Project initialized with Spring Boot 4.0.1, Vaadin 25.0.3, Java 21
- **Phase 1 Foundation COMPLETE** - Tag: 0.0.1
- **Phase 2 Core Accounting COMPLETE** - Tag: 0.0.2
- **Phase 3 Tax & Bank COMPLETE** - Tag: 0.0.3
- **Phase 4 Reports & Polish COMPLETE** - Tag: 0.0.8
- **Phase 5 Contacts & Products COMPLETE** - Tag: 0.0.9
- **Phase 6 A/R and A/P COMPLETE** - Tag: 0.1.2
- **Phase 7 Budgeting & Departments COMPLETE** - Tag: 0.1.4
- **Phase 8 Recurring Transactions COMPLETE** - Tag: 0.1.5
- **Phase 9 Report Export & Search COMPLETE** - Tag: 0.1.7
- **Phase 10 Email & Grid Customization COMPLETE** - Tag: 0.1.8
- **Phase 11 Release Readiness & Quality COMPLETE** - Tag: 0.1.9
- **Phase 12 Invoice & Statement PDFs COMPLETE** - Tag: 0.2.0
- **Phase 12b AR/AP Aging Reports UI COMPLETE** - Tag: 0.2.1
- **Phase 13a Receipt Allocation UI COMPLETE** - Tag: 0.2.2
- **Phase 13b Payment Allocation UI COMPLETE** - Tag: 0.2.3
- **Phase 13c Statement Runs COMPLETE** - Tag: 0.2.4
- **Phase 13d Statement Runs UI COMPLETE** - Tag: 0.2.5
- **Phase 14 SavedView Grid Integration COMPLETE** - Tag: 0.2.6
- **Phase 15 User & Permission Management COMPLETE** - Tag: 0.2.7
- **Phase 16 Cashflow Report & Quality Tooling COMPLETE** - Tag: 0.2.8
- **Phase 17 Account Security Level & Audit Logging COMPLETE** - Tag: 0.2.9
- **Phase 18 Report Drilldown & Allocation Rules UI COMPLETE** - Tag: 0.3.0
- **Phase 19 Payment Runs UI COMPLETE** - Tag: 0.3.1
- **Phase 20 User Invitation Workflow COMPLETE** - Tag: 0.3.2
- **Phase 21 Credit Notes for Invoices COMPLETE** - Tag: 0.3.3
- **Phase 22 Contact CSV Import COMPLETE** - Tag: 0.3.4
- **Phase 23 Budget CSV Import COMPLETE** - Tag: 0.3.5
- All 127 tests passing (PostingServiceTest: 7, ReportingServiceTest: 5, TaxCalculationServiceTest: 14, AttachmentServiceTest: 10, GlobalSearchServiceTest: 12, EmailServiceTest: 21, InvitationServiceTest: 18, SalesInvoiceServiceTest: 11, ContactImportServiceTest: 12, BudgetImportServiceTest: 16, ApplicationTest: 1)
- Core domain entities created: Company, User, Account, FiscalYear, Period, Transaction, TransactionLine, LedgerEntry, TaxCode, TaxLine, TaxReturn, TaxReturnLine, Department, Role, Permission, CompanyMembership, AuditEvent, BankStatementImport, BankFeedItem, AllocationRule, Attachment, AttachmentLink, Contact, ContactPerson, ContactNote, Product, SalesInvoice, SalesInvoiceLine, ReceivableAllocation, SupplierBill, SupplierBillLine, PayableAllocation, PaymentRun, Budget, BudgetLine, KPI, KPIValue, RecurringTemplate, RecurrenceExecutionLog, SavedView, UserInvitation
- Database configured: H2 for development, PostgreSQL for production
- Flyway migrations: V1__initial_schema.sql, V2__bank_accounts.sql, V3__tax_lines.sql, V4__tax_returns.sql, V5__attachments.sql, V6__contacts.sql, V7__products.sql, V8__sales_invoices.sql, V9__supplier_bills.sql, V10__budgets_kpis.sql, V11__rename_kpi_value_column.sql, V12__recurring_templates.sql, V13__saved_views_search.sql, V14__statement_runs.sql, V15__additional_permissions.sql, V16__user_security_level.sql, V17__user_invitations.sql, V18__credit_notes.sql
- All repository interfaces created (41 repositories)
- Full service layer: CompanyService, AccountService, TransactionService, PostingService, ReportingService, UserService, AuditService, CompanyContextService, TaxCodeService, FiscalYearService, BankImportService, TaxCalculationService, TaxReturnService, AttachmentService, ContactService, ProductService, SalesInvoiceService, ReceivableAllocationService, SupplierBillService, PayableAllocationService, PaymentRunService, RemittanceAdviceService, DepartmentService, BudgetService, KPIService, RecurringTemplateService, ReportExportService, GlobalSearchService, SavedViewService, EmailService, InvoicePdfService, StatementService, RoleService, PermissionService, InvitationService
- Full UI views: MainLayout, LoginView, DashboardView, TransactionsView, AccountsView, PeriodsView, TaxCodesView, ReportsView, BankReconciliationView, GstReturnsView, AuditEventsView, ContactsView, ProductsView, SalesInvoicesView, SupplierBillsView, DepartmentsView, BudgetsView, KPIsView, RecurringTemplatesView, GlobalSearchView, StatementRunsView, UsersView, AcceptInvitationView
- Security configuration with SecurityConfig and UserDetailsServiceImpl (using VaadinSecurityConfigurer API)

## Release 1 (SLC) - Target Features
Per specs, Release 1 must deliver:
1. Single company support (multi-tenancy foundation) - DONE
2. Chart of Accounts with hierarchical structure - DONE
3. Fiscal Years and Periods with lock/unlock - DONE
4. Cashbook transactions (Payments, Receipts, Journals) - DONE
5. Posting to immutable ledger - DONE
6. GST/Tax coding and returns - DONE (tax calculation, TaxLine entities, GST return generation)
7. Bank import (QIF/OFX) and reconciliation - DONE (import + reconciliation UI)
8. Financial reports (Trial Balance, P&L, Balance Sheet) - DONE
9. Attachments for source documents - DONE (PDF/image upload, link to transactions)
10. Audit trail - DONE (backend logging + AuditEventsView UI)

## Implementation Order

### Phase 1: Foundation (COMPLETE) - Tag: 0.0.1
- [x] Project setup with Maven, Spring Boot, Vaadin
- [x] Add database dependencies (PostgreSQL, H2, JPA, Flyway)
- [x] Configure database connections (H2 for dev, PostgreSQL for prod)
- [x] Create core domain entities
- [x] Create Flyway migrations (V1__initial_schema.sql)
- [x] Create repository layer
- [x] Create basic service layer
- [x] Create Vaadin UI shell with AppLayout
- [x] Create security configuration

### Phase 2: Core Accounting (COMPLETE) - Tag: 0.0.2
- [x] CompanyContextService for session-scoped company management
- [x] TaxCodeService for tax code management
- [x] FiscalYearService for fiscal year and period management
- [x] AccountsView with TreeGrid, search, add/edit dialogs
- [x] PeriodsView with fiscal year selection and period lock/unlock
- [x] TransactionsView with full CRUD, transaction lines grid, posting, reversals
- [x] PostingService with validation (balanced entries, open periods, active accounts)

### Phase 3: Tax & Bank (COMPLETE) - Tag: 0.0.3
- [x] Tax codes management UI
- [x] Tax calculation on transactions
- [x] Bank account linking (mark accounts as bank accounts)
- [x] Bank import (OFX/QIF parsing)
- [x] Reconciliation matching UI

### Phase 4: Reports & Polish (COMPLETE) - Tag: 0.0.8
- [x] Dashboard tiles (Cash Balance, This Month income/expenses, GST Estimate)
- [x] Trial Balance report view
- [x] P&L report view
- [x] Balance Sheet report view
- [x] GST return generation
- [x] Attachments support
- [x] Audit event logging UI

### Phase 5: Release 2 - Contacts & Products (COMPLETE) - Tag: 0.0.9
- [x] Contacts/Customers/Suppliers (spec 07)
  - Created Contact entity with code (max 11 chars), name, type (CUSTOMER/SUPPLIER/BOTH), category, colorTag
  - Full address fields (line1, line2, city, region, postalCode, country)
  - Contact details (phone, mobile, email, website)
  - Bank details for remittance (bankName, bankAccountNumber, bankRouting)
  - Tax override code for special tax handling (e.g., zero-rated exports)
  - Default account for GL allocation
  - Payment terms and credit limit
  - Created ContactPerson entity for multiple people per contact with name, email, phone, roleLabel, isPrimary
  - Created ContactNote entity for notes and follow-up reminders with noteText, followUpDate, createdBy
  - Created V6__contacts.sql migration with proper indexes
  - Created ContactRepository, ContactPersonRepository, ContactNoteRepository
  - Created ContactService with full CRUD, search, audit logging
  - Created ContactsView with master-detail split layout, searchable list, type filter
  - Detail view with tabs: General (info), People (CRUD), Defaults (accounts/terms), Notes (CRUD)
  - Added Contacts navigation to MainLayout with USERS icon
- [x] Products (spec 08 - non-inventory v1)
  - Created Product entity with code (max 31 chars), name, description, category
  - Pricing: buyPrice, sellPrice (BigDecimal 19,2)
  - Tax code reference for default tax handling
  - Default accounts: salesAccount (income), purchaseAccount (expense)
  - Barcode field, imageAttachmentId reference, isInventoried flag (for Phase 2)
  - Sticky note that appears when product selected on invoices/bills
  - Created V7__products.sql migration with proper indexes
  - Created ProductRepository with search and category queries
  - Created ProductService with full CRUD, search by barcode, audit logging
  - Created ProductsView with master-detail split layout, category filter
  - Detail view showing pricing, tax/accounts, other info, sticky note display
  - Added Products navigation to MainLayout with PACKAGE icon

### Phase 6: Release 2 - A/R and A/P (COMPLETE) - Tag: 0.1.2
- [x] Accounts Receivable (spec 09)
  - Created SalesInvoice and SalesInvoiceLine entities
  - SalesInvoice with invoiceNumber, contactId, issueDate, dueDate, status (DRAFT/ISSUED/VOID)
  - SalesInvoiceLine with product reference, description, qty, unitPrice, account, taxCode
  - Created ReceivableAllocation entity for receipt-to-invoice allocation
  - Created V8__sales_invoices.sql migration
  - Created SalesInvoiceRepository, SalesInvoiceLineRepository, ReceivableAllocationRepository
  - Created SalesInvoiceService with full CRUD, invoice issuing (posts to ledger), void capability
  - Created ReceivableAllocationService for payment allocation with auto-suggestion
  - Created SalesInvoicesView with master-detail layout, status filtering, line item management
  - Invoice issuing creates balanced journal entries (AR debit, Income credit, GST credit)
  - Added Sales Invoices navigation to MainLayout with INVOICE icon
- [x] Accounts Payable (spec 10)
  - Created SupplierBill and SupplierBillLine entities with status (DRAFT/POSTED/VOID)
  - SupplierBill with billNumber, contactId, billDate, dueDate, supplierReference
  - SupplierBillLine with product reference, description, qty, unitPrice, account, taxCode
  - Created PayableAllocation entity for payment-to-bill allocation
  - Created PaymentRun entity for batch supplier payments
  - Created V9__supplier_bills.sql migration with proper indexes
  - Created SupplierBillRepository, SupplierBillLineRepository, PayableAllocationRepository, PaymentRunRepository
  - Created SupplierBillService with full CRUD, bill posting (posts to ledger), void capability
  - Created PayableAllocationService for payment allocation with auto-suggestion
  - Created PaymentRunService for batch payment processing grouped by supplier
  - Created SupplierBillsView with master-detail layout, status filtering, line item management
  - Bill posting creates balanced journal entries (AP credit, Expense debit, GST paid debit)
  - Added Supplier Bills navigation to MainLayout with RECORDS icon
- [x] Dashboard Overdue AR/AP tiles
  - Added Overdue Receivables tile showing total overdue AR balance and up to 3 oldest overdue invoices
  - Added Overdue Payables tile showing total overdue AP balance and up to 3 oldest overdue bills
  - Uses existing repository methods: SalesInvoiceRepository.sumOverdueByCompany, SupplierBillRepository.sumOverdueByCompany
- [x] Remittance advice PDF generation (PaymentRun output)
  - Added OpenPDF library dependency for PDF generation
  - Created RemittanceAdviceService that generates professional PDFs
  - Each supplier gets their own page with company/supplier info, bill details table, and payment total
  - PDF automatically generated when PaymentRun is completed and attached to the run
  - Added PAYMENT_RUN to AttachmentLink.EntityType enum

### Phase 7: Budgeting & Departments (COMPLETE) - Tag: 0.1.3
- [x] Departments (spec 12)
  - Department entity already existed in domain with code (max 5 chars), name, groupName, classification, active
  - Created DepartmentService with full CRUD, audit logging, createDefaultDepartments
  - Created DepartmentsView with grid, add/edit/deactivate dialogs, search, create defaults button
  - Added Departments navigation to MainLayout with SITEMAP icon
- [x] Budgets (spec 12)
  - Created Budget entity with name, type (A/B), currency, active
  - Created BudgetLine entity for budget amounts per account/period/department
  - Created V10__budgets_kpis.sql migration with budget and budget_line tables
  - Created BudgetRepository and BudgetLineRepository with fiscal year queries
  - Created BudgetService with full CRUD for budgets and budget lines
  - Created BudgetsView with master-detail split layout, fiscal year selector, budget line management
  - Added Budgets navigation to MainLayout with MONEY icon
- [x] KPIs (spec 12)
  - Created KPI entity with code, name, unit, description, active
  - Created KPIValue entity for KPI values per period
  - Added kpi and kpi_value tables to V10__budgets_kpis.sql migration
  - Created KPIRepository and KPIValueRepository with fiscal year queries
  - Created KPIService with full CRUD for KPIs and KPI values, createDefaultKPIs
  - Created KPIsView with master-detail split layout, fiscal year selector, value management
  - Added KPIs navigation to MainLayout with TRENDING_UP icon
- [x] Department Filtering in P&L Report (spec 12 acceptance criteria)
  - Added department-filtered queries to LedgerEntryRepository (findByAccountAndDateRangeAndDepartment, sum methods)
  - Added overloaded generateProfitAndLoss method with optional Department parameter
  - Added department ComboBox filter to P&L tab in ReportsView
  - P&L report now shows department filter status in subtitle when filtered
- [x] Budget vs Actual Report (spec 12 acceptance criteria)
  - Added BudgetVsActual and BudgetVsActualLine record types to ReportingService
  - Added generateBudgetVsActual method that compares budget lines to actual ledger entries
  - Supports optional department filtering for both budget and actual amounts
  - Added new "Budget vs Actual" tab to ReportsView with budget selector, department filter
  - Shows variance amounts and percentages with totals row
  - Added findByFiscalYearCompanyAndDateRangeOverlap to PeriodRepository for date range queries

### Phase 8: Recurring Transactions (COMPLETE) - Tag: 0.1.5
- [x] Fixed H2 reserved keyword issue
  - Renamed 'value' column in kpi_value table to 'metric_value' (V11 migration)
  - Updated KPIValue entity with @Column(name = "metric_value") annotation
- [x] Recurring Templates (spec 11)
  - Created RecurringTemplate entity with:
    - Template types: PAYMENT, RECEIPT, JOURNAL, INVOICE, BILL
    - Frequency options: DAILY, WEEKLY, FORTNIGHTLY, MONTHLY, QUARTERLY, YEARLY
    - Status: ACTIVE, PAUSED, COMPLETED, CANCELLED
    - Execution modes: AUTO_POST, CREATE_DRAFT
    - Schedule configuration: startDate, endDate, maxOccurrences, frequencyInterval
    - Payload stored as JSON for flexible template data
  - Created RecurrenceExecutionLog entity to track execution history
  - Created V12__recurring_templates.sql migration with proper indexes
  - Created RecurringTemplateRepository and RecurrenceExecutionLogRepository
  - Created RecurringTemplateService with:
    - Full CRUD for templates
    - Create from existing Transaction, SalesInvoice, or SupplierBill
    - Pause/Resume/Cancel functionality
    - Scheduled execution (cron: daily at 2:00 AM)
    - Manual "Run Now" capability
    - Execution logging with success/failure tracking
  - Created RecurringTemplatesView with:
    - Master-detail split layout
    - Status filtering
    - Execution history grid
    - Run Due Now button for batch execution
    - Pause/Resume/Cancel/Delete actions
    - Create template dialog with JSON payload editor
  - Added Recurring navigation to MainLayout with TIME_FORWARD icon

### Phase 9: Report Export & Search (COMPLETE) - Tag: 0.1.7
- [x] PDF/Excel export for all reports (spec 13)
  - Added Apache POI dependency (poi-ooxml 5.2.5) for Excel export
  - Created ReportExportService with PDF and Excel export methods for:
    - Trial Balance (PDF with balance status, Excel with full formatting)
    - Profit & Loss (PDF with sections, Excel with income/expense breakdowns)
    - Balance Sheet (PDF with assets/liabilities/equity sections, Excel format)
    - Budget vs Actual (PDF landscape format, Excel with variance calculations)
  - Updated ReportsView with export buttons (PDF and Excel) for all report tabs
  - Export buttons appear after generating a report
  - Uses StreamResource and Anchor for browser download functionality
- [x] Global search with query expressions (spec 15)
  - Created GlobalSearchService with query expression parsing
  - Supports filter expressions: type:, status:, amount>, amount<, older_than:, newer_than:
  - Searches across transactions, contacts, products, accounts, invoices, bills
  - All searches are company-scoped for tenant isolation
  - Created GlobalSearchResult DTO with entity-type-specific factory methods
  - Added global search field in MainLayout header
  - Created GlobalSearchView with searchable results grid
  - Results show type, title/subtitle, date, amount, and status with badges
  - Click on result navigates to entity view
  - Search tips help section explains query syntax
  - Added 12 unit tests for query parsing and search behavior
- [x] Saved views (spec 15)
  - Created SavedView entity with columns, filters, sort configuration stored as JSON
  - Supports entity types: TRANSACTION, CONTACT, PRODUCT, ACCOUNT, SALES_INVOICE, SUPPLIER_BILL, RECURRING_TEMPLATE
  - Created V13__saved_views_search.sql migration
  - Created SavedViewRepository and SavedViewService with full CRUD
  - Default view support per entity type per user
  - Audit logging for view creation, update, rename, delete

### Phase 10: Email & Grid Customization (COMPLETE) - Tag: 0.1.8
- [x] Email sending integration (spec 13)
  - Created EmailService with comprehensive email building and validation
  - EmailRequest builder pattern for constructing emails with to/subject/body/attachments
  - EmailResult record for success/failure status tracking
  - Specialized methods: sendInvoice, sendStatement, sendRemittanceAdvice, sendReport
  - Email validation (address format, required fields)
  - v1 stub implementation (logging only, no actual SMTP sending)
  - Configurable via application.properties: moniworks.email.enabled, moniworks.email.from-address, moniworks.email.from-name
  - Audit logging for all email requests
  - 26 unit tests covering all email scenarios
- [x] Grid customization UI (column reorder, show/hide, save views)
  - Created GridCustomizer<T> reusable component for any grid
  - Column visibility toggles via dialog
  - Column reordering via drag-and-drop (grid.setColumnReorderingAllowed)
  - Integration with SavedView entity for persistent column configurations
  - View selector dropdown to switch between saved views
  - Save/Save As buttons for current configuration
  - Manage views dialog for rename/delete/set default
  - Reset to original columns functionality
  - Added column keys and resize support to TransactionsView grid
  - CompanyContextService.getCurrentUser() method added for user context

### Phase 11: Release Readiness & Quality (COMPLETE) - Tag: 0.1.9
- [x] Removed all TODO markers from codebase
  - TransactionsView: 3 TODO markers fixed (posting and attachment user injection)
  - GstReturnsView: 1 TODO marker fixed (tax return generation)
  - SalesInvoicesView: 1 TODO marker fixed (invoice creation)
  - SupplierBillsView: 1 TODO marker fixed (bill creation)
  - Now using companyContextService.getCurrentUser() for proper user attribution
- [x] Added spec 16 (Release Readiness and Quality Gates) documentation
  - Defines Definition of Done (DoD) criteria
  - Quality gates for no TODO/FIXME/XXX markers
  - Test coverage requirements (70% overall, 80% critical)
  - Validation commands and release workflow

### Phase 12: Invoice & Statement PDFs (COMPLETE) - Tag: 0.2.0
- [x] Invoice PDF generation (spec 09, spec 13)
  - Created InvoicePdfService for professional invoice rendering
  - Company header with invoice status (PAID/OVERDUE/ISSUED)
  - Invoice details section (number, dates, reference)
  - Bill To section with customer info
  - Line items table with #, description, qty, price, tax, amount
  - Totals section with subtotal, tax breakdown by code, and total
  - Payment information box with due date
  - PAID stamp for fully paid invoices
  - Notes section and footer
- [x] Add PDF export to SalesInvoicesView
  - Export PDF button for issued invoices (downloads PDF)
  - Email Invoice button (uses EmailService.sendInvoice with dialog)
  - Email dialog with pre-filled recipient, subject, and message
  - StreamResource-based download functionality
- [x] Customer statement generation (spec 09)
  - Created StatementService with open-item statement generation
  - StatementData record with aging buckets (Current, 1-30, 31-60, 61-90, 90+ days)
  - StatementLine record for each outstanding invoice
  - generateStatementData() for statement data
  - generateStatementPdf() for PDF output
  - Aging summary table with colored values for overdue
  - Transaction list with overdue day indicators
  - Payment information box with total due
- [x] AR/AP Aging reports (spec 13)
  - Added generateArAging() to ReportingService
  - Added generateApAging() to ReportingService
  - ArAgingReport record with customer summaries and bucket totals
  - ApAgingReport record with supplier summaries and bucket totals
  - Categorizes by aging buckets: Current, 1-30, 31-60, 61-90, 90+ days
  - Updated ReportingServiceTest with new constructor parameters
  - Statement PDF generation
- [x] AR/AP aging reports UI and export (spec 13)
  - Added AR Aging tab to ReportsView with customer summary grid
  - Added AP Aging tab to ReportsView with supplier summary grid
  - Added exportArAgingToPdf() and exportArAgingToExcel() to ReportExportService
  - Added exportApAgingToPdf() and exportApAgingToExcel() to ReportExportService
  - Aging buckets: Current, 1-30, 31-60, 61-90, 90+ days
  - PDF/Excel export buttons visible after generating reports

### Phase 13a: Receipt Allocation UI (COMPLETE) - Tag: 0.2.2
- [x] Receipt allocation UI in TransactionsView (spec 09)
  - Added "Allocate" button for posted RECEIPT transactions in TransactionsView
  - Created comprehensive allocation dialog showing:
    - Receipt info header (amount, allocated, unallocated)
    - Existing allocations grid with remove capability
    - Outstanding invoices grid with allocation amount fields
    - Auto-allocate button using suggestions (oldest first / exact match)
    - Real-time summary of total being allocated vs remaining
  - ReceivableAllocationService integration for:
    - suggestAllocations() - auto-suggestion based on amount matching
    - getUnallocatedAmount() - track remaining receipt balance
    - allocate() / removeAllocation() - create/remove allocations
- [x] Show payment allocations on invoice detail (spec 09)
  - Added allocations section to SalesInvoicesView invoice detail
  - Shows grid of allocated receipts with date, reference, amount, allocation date
  - Only displays for issued invoices with payments (amountPaid > 0)

### Phase 13b: Payment Allocation UI (COMPLETE) - Tag: 0.2.3
- [x] Payment allocation UI in TransactionsView (spec 10)
  - Added "Allocate" button for posted PAYMENT transactions in TransactionsView
  - Created comprehensive allocation dialog showing:
    - Payment info header (amount, allocated, unallocated)
    - Existing allocations grid with remove capability
    - Outstanding bills grid with allocation amount fields
    - Auto-allocate button using suggestions (oldest first / exact match)
    - Real-time summary of total being allocated vs remaining
  - PayableAllocationService integration for:
    - suggestAllocations() - auto-suggestion based on amount matching
    - getUnallocatedAmount() - track remaining payment balance
    - allocate() / removeAllocation() - create/remove allocations
- [x] Show payment allocations on bill detail (spec 10)
  - Added allocations section to SupplierBillsView bill detail
  - Shows grid of allocated payments with date, reference, amount, allocation date
  - Only displays for posted bills with payments (amountPaid > 0)

### Phase 13c: Statement Runs (COMPLETE) - Tag: 0.2.4
- [x] StatementRun entity and migration (spec 09)
  - Created StatementRun entity with status (PENDING/PROCESSING/COMPLETED/FAILED)
  - Fields: company, runDate, asOfDate, criteriaJson, statementCount, outputAttachmentId
  - Created V14__statement_runs.sql migration
  - Created StatementRunRepository with query methods
- [x] StatementRunService for batch statement processing (spec 09)
  - StatementCriteria record for filtering: minimumBalance, minimumDaysOverdue, contactIds, includeZeroBalance
  - createRun() creates a statement run with criteria stored as JSON
  - processRun() finds matching customers and generates combined PDF
  - previewCustomers() shows which customers would be included before running
  - Combined PDF puts each customer's statement on new pages
  - Audit logging for run creation, completion, and failures
  - Added STATEMENT_RUN to AttachmentLink.EntityType enum

### Phase 13d: Statement Runs UI (COMPLETE) - Tag: 0.2.5
- [x] StatementRunsView UI for batch statement generation (spec 09)
  - Created StatementRunsView with master-detail split layout
  - Grid showing all statement runs with status, date, count, created by
  - Status filter dropdown (PENDING/PROCESSING/COMPLETED/FAILED)
  - Create Statement Run dialog with:
    - As Of Date picker
    - Minimum Balance filter
    - Minimum Days Overdue filter
    - Include Zero Balance checkbox
    - Customer multi-select (optional, for specific customers)
    - Preview button showing which customers will be included
  - Process Now button for pending runs
  - Download PDF button for completed runs
  - Detail panel showing run info, criteria, and status
  - Added Statement Runs navigation to MainLayout with PRINT icon
- [x] User.getDisplayName() used instead of getFullName() (lesson learned)

### Phase 14: SavedView Grid Integration (COMPLETE) - Tag: 0.2.6
- [x] Extend GridCustomizer to additional views (spec 15)
  - Added GridCustomizer to ContactsView with column keys: code, name, type, email, phone, category, status
  - Added GridCustomizer to SalesInvoicesView with column keys: invoiceNumber, customer, issueDate, dueDate, total, balance, status
  - Added GridCustomizer to SupplierBillsView with column keys: billNumber, supplier, billDate, dueDate, total, balance, status
  - Added GridCustomizer to ProductsView with column keys: code, name, category, sellPrice, buyPrice, status
  - Added SavedViewService injection to all updated views
  - Added column resizing support (.setResizable(true)) to all columns
  - GridCustomizer allows users to save custom column layouts per view

### Phase 15: User & Permission Management (COMPLETE) - Tag: 0.2.7
- [x] Method security and permission system (spec 14)
  - Added @EnableMethodSecurity to SecurityConfig to enable method-level security
  - Created CompanyPermissionEvaluator implementing PermissionEvaluator for company-scoped permission checks
  - Created Permissions constants class with compile-time safety for all permission names
  - Created RoleService for role management with CRUD operations
  - Created PermissionService for permission management with role-permission assignments
  - Created V15__additional_permissions.sql migration adding 13 new permissions:
    - VIEW_USERS, MANAGE_USERS, VIEW_ROLES, MANAGE_ROLES
    - MANAGE_COMPANY_SETTINGS, VIEW_AUDIT_LOG, EXPORT_DATA
    - MANAGE_FISCAL_YEARS, CLOSE_PERIODS, REVERSE_TRANSACTIONS
    - MANAGE_BUDGETS, MANAGE_KPIS, MANAGE_RECURRING_TEMPLATES
  - Enhanced CompanyContextService with hasPermission() method for convenient permission checking
- [x] User interface enhancements
  - Added company switcher dropdown to MainLayout header for multi-company users
  - Added user info display and logout button to MainLayout header
  - Created UsersView for user and company membership management (admin only)
  - Added @RolesAllowed("ADMIN") to UsersView for view-level access control
- [x] Repository enhancements
  - Added findByUserIdAndCompanyId to CompanyMembershipRepository for user-company lookups
  - Added findActiveByCompany to CompanyMembershipRepository for active member queries
  - Added findByStatus to UserRepository for status-based user filtering
- [x] Service enhancements
  - Enhanced UserService with membership management methods:
    - addUserToCompany() for adding users to companies with roles
    - removeUserFromCompany() for removing memberships
    - updateMembershipRole() for changing user roles within a company
    - getUserCompanies() for listing all companies a user belongs to

### Phase 16: Cashflow Report & Quality Tooling (COMPLETE) - Tag: 0.2.8
- [x] Cashflow Report (spec 13 - "Cashflow and bank register (basic)")
  - Added generateCashflow() method to ReportingService
  - CashflowStatement record with opening/closing balances, inflows, outflows, net cash flow
  - CashflowAccountSummary record for per-bank-account breakdown
  - CashflowLine record for individual cash movements
  - Calculates opening balance (day before start) and closing balance (end date)
  - Shows reconciliation status (opening + net = closing)
  - Tracks inflows (debits to bank accounts) and outflows (credits from bank accounts)
- [x] Cashflow Report Export (spec 13)
  - Added exportCashflowToPdf() to ReportExportService
  - Added exportCashflowToExcel() to ReportExportService
  - PDF shows cash summary section and per-account breakdown
  - Excel exports with full formatting and formulas
- [x] Cashflow Tab in ReportsView
  - Added "Cashflow" tab with date range selectors
  - Cash summary section with opening, inflows, outflows, net, closing
  - Bank account summary grid with per-account breakdown
  - PDF and Excel export buttons after generating report
- [x] Forbidden Token Scan Script (spec 16 quality tooling)
  - Created scripts/check-forbidden-markers.sh
  - Scans src/main/java and src/test/java for: TODO, FIXME, XXX, HACK, TEMP, WIP, STUB
  - Uses word boundaries to avoid false positives (e.g., RECURRING_TEMPLATE)
  - Returns exit code 1 if markers found (for CI integration)
  - Added to AGENTS.md validation commands

### Phase 17: Account Security Level & Audit Logging (COMPLETE) - Tag: 0.2.9
- [x] UserSecurityLevel entity and migration (spec 02)
  - Created UserSecurityLevel entity with user, company, maxLevel
  - Created V16__user_security_level.sql migration
  - Created UserSecurityLevelRepository with query methods
  - Security levels work hierarchically: level 0 sees unrestricted accounts, level 1+ sees more
  - Admins have unlimited access (Integer.MAX_VALUE security level)
- [x] Account security level filtering in repository queries (spec 02)
  - Added findByCompanyWithSecurityLevel to AccountRepository
  - Added findByCompanyAndActiveWithSecurityLevel
  - Added findRootAccountsByCompanyWithSecurityLevel
  - Added findByParentWithSecurityLevel
  - Added findByCompanyIdAndTypeWithSecurityLevel
  - Added findBankAccountsByCompanyWithSecurityLevel
  - All queries filter out accounts where securityLevel > user's maxLevel
- [x] Security level filtering in AccountService
  - Added findByCompanyWithSecurityLevel method
  - Added findActiveByCompanyWithSecurityLevel method
  - Added findRootAccountsWithSecurityLevel method
  - Added findChildrenWithSecurityLevel method
  - Added findByTypeWithSecurityLevel method
- [x] CompanyContextService security level support (spec 02)
  - Added getCurrentSecurityLevel() method that returns user's max level
  - Admins return Integer.MAX_VALUE to see all accounts
  - Added canViewAccountWithSecurityLevel() helper method
  - Caches security level per session for performance
- [x] Security level filtering in ReportingService (spec 02)
  - Added generateTrialBalance with maxSecurityLevel parameter
  - Added generateProfitAndLoss with maxSecurityLevel parameter
  - Added generateBalanceSheet with maxSecurityLevel parameter
  - Added generateCashflow with maxSecurityLevel parameter
  - Added generateBudgetVsActual with maxSecurityLevel parameter
  - Reports exclude accounts above user's security level
- [x] Dashboard security level filtering (spec 02, spec 13)
  - Cash Balance tile filters bank accounts by security level
  - This Month tile uses security-filtered P&L report
  - Users only see data for accounts they have access to
- [x] Master data edit audit logging (spec 14)
  - AccountService: logs ACCOUNT_CREATED, ACCOUNT_UPDATED with before/after changes, ACCOUNT_DEACTIVATED
  - TaxCodeService: logs TAXCODE_CREATED, TAXCODE_UPDATED with before/after changes, TAXCODE_DEACTIVATED
  - ContactService: logs CONTACT_UPDATED with before/after changes (CREATED and DEACTIVATED already existed)
  - ProductService: logs PRODUCT_UPDATED with before/after changes (CREATED and DEACTIVATED already existed)
  - Changes tracked include: code, name, type, active, and entity-specific fields
- [x] Updated ReportingServiceTest to use new security-filtered mocks

### Phase 18: Report Drilldown & Allocation Rules UI (COMPLETE) - Tag: 0.3.0
- [x] Report drilldown functionality (spec 06, spec 13)
  - Added click-through drilldown from report lines to underlying ledger entries
  - Trial Balance: click row to see ledger entries for that account
  - Profit & Loss: click income/expense row to see ledger entries (supports department filtering)
  - Balance Sheet: click asset/liability/equity row to see ledger entries
  - Budget vs Actual: click row to see ledger entries for that account
  - AR Aging: click customer row to see outstanding invoices
  - AP Aging: click supplier row to see outstanding bills
  - All drilldown dialogs show relevant details and totals
- [x] GST return drilldown (spec 06)
  - Added click-through from GST return boxes to contributing tax lines/transactions
  - Shows tax code, taxable amount, and tax amount for each transaction
  - Total and transaction count displayed
- [x] Allocation Rules Management UI (spec 05, spec 11)
  - Created AllocationRulesView with full CRUD for allocation rules
  - Priority-based rule ordering (higher priority first)
  - Match expression configuration with case-insensitive contains matching
  - Target account and optional tax code assignment
  - Enable/disable rules
  - Test rules feature to verify matching against sample descriptions
  - Audit logging for rule creation, update, and deletion
  - Added navigation to MainLayout with AUTOMATION icon

### Phase 19: Payment Runs UI (COMPLETE) - Tag: 0.3.1
- [x] PaymentRunsView for batch supplier payments (spec 10)
  - Created PaymentRunsView with master-detail split layout
  - Payment run wizard with step-by-step flow:
    - Select bank account and payment date
    - Filter bills by due date and/or specific suppliers
    - Multi-select bills to include in run
    - Preview total and bills grouped by supplier
    - Create draft or create and complete in one step
  - Bills grid showing: bill number, supplier, dates, total, payment amount
  - Summary by supplier showing totals per vendor
  - Actions: Add Bills, Complete Run (for drafts); Download Remittance, Email Remittance (for completed)
  - Remove bills from draft runs
  - Email remittance to suppliers with email addresses configured
  - Added navigation to MainLayout with MONEY_EXCHANGE icon
- [x] Added findBankAccountsByCompany and findBankAccountsByCompanyWithSecurityLevel to AccountService
  - Exposes existing AccountRepository methods for finding bank accounts

### Phase 20: User Invitation Workflow (COMPLETE) - Tag: 0.3.2
- [x] User Invitation entity and migration (spec 02)
  - Created UserInvitation entity with token, expiresAt, status (PENDING/ACCEPTED/EXPIRED/CANCELLED)
  - Fields: email, displayName, company, role, invitedBy, acceptedAt, acceptedUser
  - Created V17__user_invitations.sql migration with indexes
  - Created UserInvitationRepository with query methods for pending/expired invitations
- [x] InvitationService for invitation workflow (spec 02)
  - createInvitation() generates secure token and sends invitation email
  - validateToken() checks if token is valid and not expired
  - acceptInvitationNewUser() creates user account and company membership
  - acceptInvitationExistingUser() creates membership for logged-in users
  - cancelInvitation() and resendInvitation() for admin management
  - @Scheduled task to expire old invitations daily at 3 AM
  - Configurable expiry days (default 7) via moniworks.invitation.expiry-days
  - Configurable base URL via moniworks.invitation.base-url
- [x] AcceptInvitationView (spec 02)
  - Public view (@AnonymousAllowed) for accepting invitations via token
  - Handles new user registration with password setup
  - Handles existing logged-in users accepting invitations
  - Validates email match for existing users
  - Shows invitation details (company, role, expiry, inviter)
  - Redirects to login on success for new users
- [x] UsersView enhancements (spec 02)
  - Added "Invite by Email" button with invitation dialog
  - Added "Pending Invitations" tab showing all company invitations
  - Invitation detail view with resend/cancel/copy link actions
  - Status display and expiry tracking
  - Invitation grid with email, role, status, expires, invited by columns
- [x] InvitationServiceTest with 18 unit tests covering:
  - Create invitation success and failure scenarios
  - Token validation (valid, expired, accepted, nonexistent)
  - Accept invitation for new and existing users
  - Cancel and resend invitation workflows
  - URL generation

### Phase 21: Credit Notes for Invoices (COMPLETE) - Tag: 0.3.3
- [x] Credit Note entity support (spec 09)
  - Added InvoiceType enum (INVOICE, CREDIT_NOTE) to SalesInvoice
  - Added type field and originalInvoice reference to SalesInvoice
  - Created V18__credit_notes.sql migration adding invoice_type and original_invoice_id columns
  - Added helper methods: isCreditNote(), isInvoice() to SalesInvoice entity
- [x] Credit Note service methods (spec 09)
  - Added generateCreditNoteNumber() using CN-{originalNumber} pattern with suffix for multiples
  - Added createCreditNote() to create draft credit note against issued invoice
  - Supports full credit (copies all lines) or partial credit (empty draft for manual entry)
  - Added issueCreditNote() that posts reversed ledger entries:
    - Credit AR control account (reduces receivable)
    - Debit income accounts (reduces income)
    - Debit GST collected (reduces tax liability)
  - Validates credit note amount doesn't exceed invoice remaining balance
  - Credit note total automatically reduces original invoice balance
  - Added findCreditNotesForInvoice() to find all credit notes for an invoice
  - Added findByOriginalInvoice() to SalesInvoiceRepository
- [x] Credit Note UI (spec 09)
  - Added "Credit Note" button on issued invoices in SalesInvoicesView
  - Create Credit Note dialog with full/partial credit options
  - Invoice detail shows "CREDIT NOTE" type badge for credit notes
  - Shows link to original invoice for credit notes
  - Shows list of issued credit notes for invoices
  - Issue button correctly calls issueCreditNote() for credit notes
- [x] SalesInvoiceServiceTest with 11 unit tests covering:
  - Create full credit note success
  - Create partial credit note (empty draft)
  - Cannot create credit note against draft invoice
  - Cannot create credit note against another credit note
  - Second credit note gets incremented suffix
  - Issue credit note posts reversed entries
  - Cannot issue credit note exceeding invoice balance
  - Cannot issue regular invoice as credit note
  - Cannot issue already-issued credit note
  - Cannot issue credit note with no lines
  - Find credit notes for invoice

### Phase 22: Contact CSV Import (COMPLETE) - Tag: 0.3.4
- [x] ContactImportService for CSV parsing (spec 07)
  - Flexible column mapping with case-insensitive header matching
  - Required columns: code, name
  - Optional columns: type, category, email, phone, mobile, website, address fields, paymentTerms, creditLimit, bank details, taxOverrideCode
  - Handles quoted fields with embedded commas
  - Header name normalization (removes spaces, underscores, hyphens)
  - Code length validation (max 11 characters)
  - Credit limit parsing with comma removal
  - Country code truncation to 2 characters
- [x] Import and update modes
  - Import only mode skips existing contacts by code
  - Update mode updates existing contacts with new values
  - Preview mode to see changes before committing
- [x] Import UI in ContactsView
  - "Import CSV" button in toolbar
  - Import dialog with instructions and sample CSV download
  - File upload with CSV format validation
  - Preview of import results before committing
  - "Update existing contacts" checkbox option
  - Error and warning display
- [x] ContactImportServiceTest with 12 unit tests covering:
  - Valid CSV import
  - Missing required columns (code, name)
  - Empty file handling
  - Code length validation
  - Skip existing contacts mode
  - Update existing contacts mode
  - All fields parsing
  - Quoted fields with commas
  - Flexible column name formats
  - Preview mode without saving

### Phase 23: Budget CSV Import (COMPLETE) - Tag: 0.3.5
- [x] BudgetImportService for CSV parsing (spec 12)
  - Flexible column mapping with case-insensitive header matching
  - Required columns: account_code, period_date, amount
  - Optional column: department_code
  - Multiple date format support (YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY, etc.)
  - Amount parsing with comma and dollar sign removal
  - Account code validation against company accounts
  - Period lookup by date (finds period containing the given date)
  - Optional department validation
- [x] Import and update modes
  - Import only mode skips existing budget lines (same account/period/department)
  - Update mode updates existing budget lines with new amounts
  - Preview mode to see changes before committing
- [x] Import UI in BudgetsView
  - "Import CSV" button in budget detail panel
  - Import dialog with instructions and sample CSV download
  - File upload with CSV format validation
  - Preview of import results before committing
  - "Update existing budget lines" checkbox option
  - Error and warning display
- [x] BudgetImportServiceTest with 16 unit tests covering:
  - Valid CSV import
  - Missing required columns
  - Account not found
  - Period not found
  - Invalid date format
  - Invalid amount format
  - Skip existing lines mode
  - Update existing lines mode
  - Department parsing
  - Department not found
  - Multiple date formats
  - Amount with commas and dollar signs
  - Preview mode without saving

## Lessons Learned
- VaadinWebSecurity deprecated in Vaadin 24.8+ - use VaadinSecurityConfigurer.vaadin() instead
- Test profile should use hibernate.ddl-auto=create-drop with Flyway disabled to avoid schema conflicts
- AuditService should create its own ObjectMapper rather than injecting as bean for test isolation
- TreeGrid requires TreeDataProvider with proper parent-child hierarchy setup
- @VaadinSessionScope for session-scoped beans (like CompanyContextService)
- When adding new dependencies to PostingService (like TaxCalculationService), update unit tests to include mocks
- Vaadin 25+ deprecates MemoryBuffer and StreamResource - functionality still works but will need update in future versions
- File attachments stored outside DB with checksums for integrity; deduplication by checksum within company scope
- AuditService.logEvent requires User parameter (can be null for system actions)
- AccountService.findByType takes companyId (Long), not Company object
- REGEXP is not supported in HQL/JPQL - use application-side filtering for regex-like matching
- TransactionService.createTransaction requires description parameter
- OpenPDF (com.github.librepdf:openpdf) used for PDF generation - provides Document, PdfWriter, PdfPTable classes
- When adding new services that need circular dependencies (like RemittanceAdviceService in PaymentRunService), ensure constructor injection order
- FiscalYear uses getLabel() not getName() - Period uses getStartDate()/getEndDate() without getName()
- Use DateTimeFormatter for displaying period names (e.g., "MMM yyyy")
- AccountService.findByCompany takes Company object, not companyId
- When adding new constructor parameters to services (like ReportingService), update all unit tests to include mocks for the new dependencies
- H2 reserves 'value' as a keyword - renamed kpi_value.value to metric_value via migration V11
- AuditService.logEvent signature: (Company, User, String eventType, String entityType, Long entityId, String summary) - use strings not enums
- @Scheduled annotation requires Spring's scheduling to be enabled (@EnableScheduling on Application class)
- JSON payload serialization for recurring templates uses Jackson ObjectMapper with ObjectNode/ArrayNode builders
- When using both OpenPDF and Apache POI, fully qualify Row/Cell/Font classes to avoid ambiguity (use org.apache.poi.ss.usermodel.Row, etc.)
- Apache POI (poi-ooxml) used for Excel export - provides XSSFWorkbook for .xlsx format
- StreamResource with Anchor and download attribute creates browser download functionality in Vaadin
- LumoUtility.FontStyle may not be available in all Vaadin versions - use inline style instead: element.getStyle().set("font-style", "italic")
- When creating Vaadin views with listeners referencing other UI components, ensure those components are initialized before the listener is defined to avoid "variable might not have been initialized" errors
- TransactionLine uses amount/direction (DEBIT/CREDIT) pattern, not separate debitAmount/creditAmount fields
- SalesInvoiceRepository uses findByCompanyOrderByIssueDateDescInvoiceNumberDesc, SupplierBillRepository uses findByCompanyOrderByBillDateDescBillNumberDesc
- SalesInvoice uses getTotal() not getTotalAmount() for the invoice total
- Vaadin TextField uses setAutoselect(true) instead of selectAll() method
- GridCustomizer requires column keys (.setKey()) to be set on grid columns for customization to work
- CompanyContextService.getCurrentUser() uses SecurityContextHolder to get authenticated user
- When adding new constructor parameters to services (like ReportingService AR/AP repos), must update unit tests
- Statement generation uses findOutstandingByCompanyAndContact which filters by balance > 0 already
- AR/AP Aging reports categorize by days overdue using ChronoUnit.DAYS.between(dueDate, asOfDate)
- Vaadin Grid Column does not have setClassNameGenerator() method - use Grid.setClassNameGenerator() on the grid instead
- User entity uses getDisplayName() not getFullName() for user's display name
- SecurityConfig with @EnableMethodSecurity requires a MethodSecurityExpressionHandler bean with custom PermissionEvaluator
- Company-scoped permission checks use CompanyPermissionEvaluator.hasCompanyPermission() via @PreAuthorize
- Vaadin views can use @RolesAllowed for role-based access control at the view level
- CompanyContextService.hasPermission() provides convenient permission checking in UI components
- AccountRepository now has security-level filtered variants of all queries - use WithSecurityLevel suffix methods when user context matters
- AuditService.logEvent with changes Map parameter serializes before/after values to detailsJson for tracking field changes
- Grid addItemClickListener() enables drilldown functionality - combine with cursor pointer styling for UX hint
- Vaadin Checkbox doesn't have setUserData/getUserData methods - use a Map<Checkbox, Object> to associate data with checkboxes
- EmailService.EmailResult.queued() is a static factory method, not an instance method - check status with result.status().equals("QUEUED")
- EmailService.sendRemittanceAdvice signature is (Contact, Company, byte[], User) - contact first, not company
- User invitation tokens use SecureRandom with Base64 URL encoding for security
- Vaadin @AnonymousAllowed annotation allows public access to views without Spring Security config changes
- ReflectionTestUtils.setField() used to inject @Value fields in unit tests

## Technical Notes
- Build: `./mvnw compile`
- Test: `./mvnw test`
- Run: `./mvnw spring-boot:run` (starts on http://localhost:8080)
- Package: `./mvnw package -Pproduction`
- Run with production profile: `java -jar target/moniworks-1.0-SNAPSHOT.jar --spring.profiles.active=prod`
- mvnw needs `chmod +x` after clone
- H2 console available in dev mode at http://localhost:8080/h2-console

## Architecture Decisions
- Money stored as BigDecimal with 2 decimal places (minor units)
- Dates: LocalDate for accounting, Instant for audit timestamps
- Ledger entries are immutable - corrections via reversals only
- Multi-tenant: All entities include companyId, enforced in queries
- Session-scoped CompanyContextService manages current company per user session
- Tax calculation assumes tax-inclusive amounts (NZ standard) - extracts GST from totals
- TaxLine records created during posting for audit trail and return generation
- Attachments stored on filesystem with path: {storagePath}/{companyId}/{year}/{month}/{uuid}_{sanitizedFilename}
- Attachment deduplication by SHA-256 checksum within company scope (avoids storing same file twice)
- Audit events are append-only and immutable - no delete capability exposed in UI
- Contacts support CUSTOMER, SUPPLIER, or BOTH types for flexible use in A/R and A/P
- Products have separate sales and purchase accounts for proper P&L allocation
