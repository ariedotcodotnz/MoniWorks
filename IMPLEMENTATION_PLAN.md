# MoniWorks Implementation Plan

## Current Status
- Project initialized with Spring Boot 4.0.1, Vaadin 25.0.3, Java 21
- **Phase 1 Foundation COMPLETE** - Tag: 0.0.1
- **Phase 2 Core Accounting COMPLETE** - Tag: 0.0.2
- **Phase 3 Tax & Bank COMPLETE** - Tag: 0.0.3
- **Phase 4 Reports & Polish COMPLETE** - Tag: 0.0.8
- **Phase 5 Contacts & Products COMPLETE** - Tag: 0.0.9
- **Phase 6 A/R and A/P COMPLETE** - Tag: 0.1.2
- **Phase 7 Budgeting & Departments COMPLETE** - Tag: 0.1.4
- **Phase 8 Recurring Transactions COMPLETE** - Tag: 0.1.5
- **Phase 9 Report Export & Search COMPLETE** - Tag: 0.1.7
- **Phase 10 Email & Grid Customization COMPLETE** - Tag: 0.1.8
- **Phase 11 Release Readiness & Quality COMPLETE** - Tag: 0.1.9
- **Phase 12 Invoice & Statement PDFs COMPLETE** - Tag: 0.2.0
- **Phase 12b AR/AP Aging Reports UI COMPLETE** - Tag: 0.2.1
- **Phase 13a Receipt Allocation UI COMPLETE** - Tag: 0.2.2
- **Phase 13b Payment Allocation UI COMPLETE** - Tag: 0.2.3
- **Phase 13c Statement Runs COMPLETE** - Tag: 0.2.4
- **Phase 13d Statement Runs UI COMPLETE** - Tag: 0.2.5
- **Phase 14 SavedView Grid Integration COMPLETE** - Tag: 0.2.6
- **Phase 15 User & Permission Management COMPLETE** - Tag: 0.2.7
- **Phase 16 Cashflow Report & Quality Tooling COMPLETE** - Tag: 0.2.8
- **Phase 17 Account Security Level & Audit Logging COMPLETE** - Tag: 0.2.9
- **Phase 18 Report Drilldown & Allocation Rules UI COMPLETE** - Tag: 0.3.0
- **Phase 19 Payment Runs UI COMPLETE** - Tag: 0.3.1
- **Phase 20 User Invitation Workflow COMPLETE** - Tag: 0.3.2
- **Phase 21 Credit Notes for Invoices COMPLETE** - Tag: 0.3.3
- **Phase 22 Contact CSV Import COMPLETE** - Tag: 0.3.4
- **Phase 23 Budget CSV Import COMPLETE** - Tag: 0.3.5
- **Phase 24 Login Event Tracking COMPLETE** - Tag: 0.3.6
- **Phase 25 Product CSV Import COMPLETE** - Tag: 0.3.7
- **Phase 26 Role Management UI COMPLETE** - Tag: 0.3.8
- **Phase 27 PDF Template Customization COMPLETE** - Tag: 0.3.9
- **Phase 28 Security Level UI Enforcement COMPLETE** - Tag: 0.4.0
- **Phase 29 Bank Register Report COMPLETE** - Tag: 0.4.1
- **Phase 30 Bank Register Transaction Drilldown COMPLETE** - Tag: 0.4.2
- **Phase 31 Tax Basis Settings UI COMPLETE** - Tag: 0.4.3
- **Phase 32 Tax Default Auto-Population COMPLETE** - Tag: 0.4.4
- **Phase 33 Allocation Rule Auto-Suggest COMPLETE** - Tag: 0.4.5
- **Phase 34 Balance-Forward Statements COMPLETE** - Tag: 0.4.6
- **Phase 35 Contact Tax Override Auto-Population COMPLETE** - Tag: 0.4.7
- **Phase 36 Quality Tooling & Keyboard Shortcuts COMPLETE** - Tag: 0.4.8
- **Phase 37 KPI & Income Trend Charting COMPLETE** - Tag: 0.4.9
- **Phase 38 Bank Reconciliation Status Report COMPLETE** - Tag: 0.5.0
- **Phase 39 SMTP Email Sending COMPLETE** - Tag: 0.5.1
- **Phase 40 Transfer Transactions & Reconciliation Audit Trail COMPLETE** - Tag: 0.5.2
- **Phase 41 Complete Bank Reconciliation Integration COMPLETE** - Tag: 0.5.3
- **Phase 42 Credit Note Voiding COMPLETE** - Tag: 0.5.4
- **Phase 44 Split Transaction for Bank Reconciliation COMPLETE** - Tag: 0.5.6
- **Phase 45 Allocation Rule Enhancements COMPLETE** - Tag: 0.5.7
- **Phase 46 Debit Notes for Supplier Bills COMPLETE** - Tag: 0.5.8
- **Phase 47 Transaction CSV Import COMPLETE** - Tag: 0.5.9
- **Phase 48 Email Statements to Customers COMPLETE** - Tag: 0.6.0
- **Phase 49 Supplier Bill PDF Export COMPLETE** - Tag: 0.6.1
- **Phase 50 ReversalLink Entity COMPLETE** - Tag: 0.6.2
- All 255 tests passing (PostingServiceTest: 7, ReportingServiceTest: 5, TaxCalculationServiceTest: 14, AttachmentServiceTest: 10, GlobalSearchServiceTest: 12, EmailServiceTest: 23, InvitationServiceTest: 18, SalesInvoiceServiceTest: 15, ContactImportServiceTest: 12, BudgetImportServiceTest: 16, ProductImportServiceTest: 14, ApplicationTest: 1, AuthenticationEventListenerTest: 5, AuditLogoutHandlerTest: 4, ReceivableAllocationServiceTest: 13, PayableAllocationServiceTest: 13, BankImportServiceTest: 13, AllocationRuleTest: 24, SupplierBillServiceTest: 15, TransactionImportServiceTest: 21)
- Core domain entities created: Company, User, Account, FiscalYear, Period, Transaction, TransactionLine, LedgerEntry, TaxCode, TaxLine, TaxReturn, TaxReturnLine, Department, Role, Permission, CompanyMembership, AuditEvent, BankStatementImport, BankFeedItem, AllocationRule, Attachment, AttachmentLink, Contact, ContactPerson, ContactNote, Product, SalesInvoice, SalesInvoiceLine, ReceivableAllocation, SupplierBill, SupplierBillLine, PayableAllocation, PaymentRun, Budget, BudgetLine, KPI, KPIValue, RecurringTemplate, RecurrenceExecutionLog, SavedView, UserInvitation, ReconciliationMatch
- Database configured: H2 for development, PostgreSQL for production
- Flyway migrations: V1__initial_schema.sql, V2__bank_accounts.sql, V3__tax_lines.sql, V4__tax_returns.sql, V5__attachments.sql, V6__contacts.sql, V7__products.sql, V8__sales_invoices.sql, V9__supplier_bills.sql, V10__budgets_kpis.sql, V11__rename_kpi_value_column.sql, V12__recurring_templates.sql, V13__saved_views_search.sql, V14__statement_runs.sql, V15__additional_permissions.sql, V16__user_security_level.sql, V17__user_invitations.sql, V18__credit_notes.sql, V19__reconciliation_match.sql, V20__ledger_entry_reconciliation.sql, V21__allocation_rule_amount_range.sql
- All repository interfaces created (42 repositories)
- Full service layer: CompanyService, AccountService, TransactionService, PostingService, ReportingService, UserService, AuditService, CompanyContextService, TaxCodeService, FiscalYearService, BankImportService, TaxCalculationService, TaxReturnService, AttachmentService, ContactService, ProductService, SalesInvoiceService, ReceivableAllocationService, SupplierBillService, PayableAllocationService, PaymentRunService, RemittanceAdviceService, DepartmentService, BudgetService, KPIService, RecurringTemplateService, ReportExportService, GlobalSearchService, SavedViewService, EmailService, InvoicePdfService, StatementService, RoleService, PermissionService, InvitationService, TransactionImportService
- Full UI views: MainLayout, LoginView, DashboardView, TransactionsView, AccountsView, PeriodsView, TaxCodesView, ReportsView, BankReconciliationView, GstReturnsView, AuditEventsView, ContactsView, ProductsView, SalesInvoicesView, SupplierBillsView, DepartmentsView, BudgetsView, KPIsView, RecurringTemplatesView, GlobalSearchView, StatementRunsView, UsersView, AcceptInvitationView, RolesView, CompanySettingsView
- Security configuration with SecurityConfig and UserDetailsServiceImpl (using VaadinSecurityConfigurer API)

## Release 1 (SLC) - Target Features
Per specs, Release 1 must deliver:
1. Single company support (multi-tenancy foundation) - DONE
2. Chart of Accounts with hierarchical structure - DONE
3. Fiscal Years and Periods with lock/unlock - DONE
4. Cashbook transactions (Payments, Receipts, Journals) - DONE
5. Posting to immutable ledger - DONE
6. GST/Tax coding and returns - DONE (tax calculation, TaxLine entities, GST return generation)
7. Bank import (QIF/OFX) and reconciliation - DONE (import + reconciliation UI)
8. Financial reports (Trial Balance, P&L, Balance Sheet) - DONE
9. Attachments for source documents - DONE (PDF/image upload, link to transactions)
10. Audit trail - DONE (backend logging + AuditEventsView UI)

## Implementation Order

### Phase 1: Foundation (COMPLETE) - Tag: 0.0.1
- [x] Project setup with Maven, Spring Boot, Vaadin
- [x] Add database dependencies (PostgreSQL, H2, JPA, Flyway)
- [x] Configure database connections (H2 for dev, PostgreSQL for prod)
- [x] Create core domain entities
- [x] Create Flyway migrations (V1__initial_schema.sql)
- [x] Create repository layer
- [x] Create basic service layer
- [x] Create Vaadin UI shell with AppLayout
- [x] Create security configuration

### Phase 2: Core Accounting (COMPLETE) - Tag: 0.0.2
- [x] CompanyContextService for session-scoped company management
- [x] TaxCodeService for tax code management
- [x] FiscalYearService for fiscal year and period management
- [x] AccountsView with TreeGrid, search, add/edit dialogs
- [x] PeriodsView with fiscal year selection and period lock/unlock
- [x] TransactionsView with full CRUD, transaction lines grid, posting, reversals
- [x] PostingService with validation (balanced entries, open periods, active accounts)

### Phase 3: Tax & Bank (COMPLETE) - Tag: 0.0.3
- [x] Tax codes management UI
- [x] Tax calculation on transactions
- [x] Bank account linking (mark accounts as bank accounts)
- [x] Bank import (OFX/QIF parsing)
- [x] Reconciliation matching UI

### Phase 4: Reports & Polish (COMPLETE) - Tag: 0.0.8
- [x] Dashboard tiles (Cash Balance, This Month income/expenses, GST Estimate)
- [x] Trial Balance report view
- [x] P&L report view
- [x] Balance Sheet report view
- [x] GST return generation
- [x] Attachments support
- [x] Audit event logging UI

### Phase 5: Release 2 - Contacts & Products (COMPLETE) - Tag: 0.0.9
- [x] Contacts/Customers/Suppliers (spec 07)
  - Created Contact entity with code (max 11 chars), name, type (CUSTOMER/SUPPLIER/BOTH), category, colorTag
  - Full address fields (line1, line2, city, region, postalCode, country)
  - Contact details (phone, mobile, email, website)
  - Bank details for remittance (bankName, bankAccountNumber, bankRouting)
  - Tax override code for special tax handling (e.g., zero-rated exports)
  - Default account for GL allocation
  - Payment terms and credit limit
  - Created ContactPerson entity for multiple people per contact with name, email, phone, roleLabel, isPrimary
  - Created ContactNote entity for notes and follow-up reminders with noteText, followUpDate, createdBy
  - Created V6__contacts.sql migration with proper indexes
  - Created ContactRepository, ContactPersonRepository, ContactNoteRepository
  - Created ContactService with full CRUD, search, audit logging
  - Created ContactsView with master-detail split layout, searchable list, type filter
  - Detail view with tabs: General (info), People (CRUD), Defaults (accounts/terms), Notes (CRUD)
  - Added Contacts navigation to MainLayout with USERS icon
- [x] Products (spec 08 - non-inventory v1)
  - Created Product entity with code (max 31 chars), name, description, category
  - Pricing: buyPrice, sellPrice (BigDecimal 19,2)
  - Tax code reference for default tax handling
  - Default accounts: salesAccount (income), purchaseAccount (expense)
  - Barcode field, imageAttachmentId reference, isInventoried flag (for Phase 2)
  - Sticky note that appears when product selected on invoices/bills
  - Created V7__products.sql migration with proper indexes
  - Created ProductRepository with search and category queries
  - Created ProductService with full CRUD, search by barcode, audit logging
  - Created ProductsView with master-detail split layout, category filter
  - Detail view showing pricing, tax/accounts, other info, sticky note display
  - Added Products navigation to MainLayout with PACKAGE icon

### Phase 6: Release 2 - A/R and A/P (COMPLETE) - Tag: 0.1.2
- [x] Accounts Receivable (spec 09)
  - Created SalesInvoice and SalesInvoiceLine entities
  - SalesInvoice with invoiceNumber, contactId, issueDate, dueDate, status (DRAFT/ISSUED/VOID)
  - SalesInvoiceLine with product reference, description, qty, unitPrice, account, taxCode
  - Created ReceivableAllocation entity for receipt-to-invoice allocation
  - Created V8__sales_invoices.sql migration
  - Created SalesInvoiceRepository, SalesInvoiceLineRepository, ReceivableAllocationRepository
  - Created SalesInvoiceService with full CRUD, invoice issuing (posts to ledger), void capability
  - Created ReceivableAllocationService for payment allocation with auto-suggestion
  - Created SalesInvoicesView with master-detail layout, status filtering, line item management
  - Invoice issuing creates balanced journal entries (AR debit, Income credit, GST credit)
  - Added Sales Invoices navigation to MainLayout with INVOICE icon
- [x] Accounts Payable (spec 10)
  - Created SupplierBill and SupplierBillLine entities with status (DRAFT/POSTED/VOID)
  - SupplierBill with billNumber, contactId, billDate, dueDate, supplierReference
  - SupplierBillLine with product reference, description, qty, unitPrice, account, taxCode
  - Created PayableAllocation entity for payment-to-bill allocation
  - Created PaymentRun entity for batch supplier payments
  - Created V9__supplier_bills.sql migration with proper indexes
  - Created SupplierBillRepository, SupplierBillLineRepository, PayableAllocationRepository, PaymentRunRepository
  - Created SupplierBillService with full CRUD, bill posting (posts to ledger), void capability
  - Created PayableAllocationService for payment allocation with auto-suggestion
  - Created PaymentRunService for batch payment processing grouped by supplier
  - Created SupplierBillsView with master-detail layout, status filtering, line item management
  - Bill posting creates balanced journal entries (AP credit, Expense debit, GST paid debit)
  - Added Supplier Bills navigation to MainLayout with RECORDS icon
- [x] Dashboard Overdue AR/AP tiles
  - Added Overdue Receivables tile showing total overdue AR balance and up to 3 oldest overdue invoices
  - Added Overdue Payables tile showing total overdue AP balance and up to 3 oldest overdue bills
  - Uses existing repository methods: SalesInvoiceRepository.sumOverdueByCompany, SupplierBillRepository.sumOverdueByCompany
- [x] Remittance advice PDF generation (PaymentRun output)
  - Added OpenPDF library dependency for PDF generation
  - Created RemittanceAdviceService that generates professional PDFs
  - Each supplier gets their own page with company/supplier info, bill details table, and payment total
  - PDF automatically generated when PaymentRun is completed and attached to the run
  - Added PAYMENT_RUN to AttachmentLink.EntityType enum

### Phase 7: Budgeting & Departments (COMPLETE) - Tag: 0.1.3
- [x] Departments (spec 12)
  - Department entity already existed in domain with code (max 5 chars), name, groupName, classification, active
  - Created DepartmentService with full CRUD, audit logging, createDefaultDepartments
  - Created DepartmentsView with grid, add/edit/deactivate dialogs, search, create defaults button
  - Added Departments navigation to MainLayout with SITEMAP icon
- [x] Budgets (spec 12)
  - Created Budget entity with name, type (A/B), currency, active
  - Created BudgetLine entity for budget amounts per account/period/department
  - Created V10__budgets_kpis.sql migration with budget and budget_line tables
  - Created BudgetRepository and BudgetLineRepository with fiscal year queries
  - Created BudgetService with full CRUD for budgets and budget lines
  - Created BudgetsView with master-detail split layout, fiscal year selector, budget line management
  - Added Budgets navigation to MainLayout with MONEY icon
- [x] KPIs (spec 12)
  - Created KPI entity with code, name, unit, description, active
  - Created KPIValue entity for KPI values per period
  - Added kpi and kpi_value tables to V10__budgets_kpis.sql migration
  - Created KPIRepository and KPIValueRepository with fiscal year queries
  - Created KPIService with full CRUD for KPIs and KPI values, createDefaultKPIs
  - Created KPIsView with master-detail split layout, fiscal year selector, value management
  - Added KPIs navigation to MainLayout with TRENDING_UP icon
- [x] Department Filtering in P&L Report (spec 12 acceptance criteria)
  - Added department-filtered queries to LedgerEntryRepository (findByAccountAndDateRangeAndDepartment, sum methods)
  - Added overloaded generateProfitAndLoss method with optional Department parameter
  - Added department ComboBox filter to P&L tab in ReportsView
  - P&L report now shows department filter status in subtitle when filtered
- [x] Budget vs Actual Report (spec 12 acceptance criteria)
  - Added BudgetVsActual and BudgetVsActualLine record types to ReportingService
  - Added generateBudgetVsActual method that compares budget lines to actual ledger entries
  - Supports optional department filtering for both budget and actual amounts
  - Added new "Budget vs Actual" tab to ReportsView with budget selector, department filter
  - Shows variance amounts and percentages with totals row
  - Added findByFiscalYearCompanyAndDateRangeOverlap to PeriodRepository for date range queries

### Phase 8: Recurring Transactions (COMPLETE) - Tag: 0.1.5
- [x] Fixed H2 reserved keyword issue
  - Renamed 'value' column in kpi_value table to 'metric_value' (V11 migration)
  - Updated KPIValue entity with @Column(name = "metric_value") annotation
- [x] Recurring Templates (spec 11)
  - Created RecurringTemplate entity with:
    - Template types: PAYMENT, RECEIPT, JOURNAL, INVOICE, BILL
    - Frequency options: DAILY, WEEKLY, FORTNIGHTLY, MONTHLY, QUARTERLY, YEARLY
    - Status: ACTIVE, PAUSED, COMPLETED, CANCELLED
    - Execution modes: AUTO_POST, CREATE_DRAFT
    - Schedule configuration: startDate, endDate, maxOccurrences, frequencyInterval
    - Payload stored as JSON for flexible template data
  - Created RecurrenceExecutionLog entity to track execution history
  - Created V12__recurring_templates.sql migration with proper indexes
  - Created RecurringTemplateRepository and RecurrenceExecutionLogRepository
  - Created RecurringTemplateService with:
    - Full CRUD for templates
    - Create from existing Transaction, SalesInvoice, or SupplierBill
    - Pause/Resume/Cancel functionality
    - Scheduled execution (cron: daily at 2:00 AM)
    - Manual "Run Now" capability
    - Execution logging with success/failure tracking
  - Created RecurringTemplatesView with:
    - Master-detail split layout
    - Status filtering
    - Execution history grid
    - Run Due Now button for batch execution
    - Pause/Resume/Cancel/Delete actions
    - Create template dialog with JSON payload editor
  - Added Recurring navigation to MainLayout with TIME_FORWARD icon

### Phase 9: Report Export & Search (COMPLETE) - Tag: 0.1.7
- [x] PDF/Excel export for all reports (spec 13)
  - Added Apache POI dependency (poi-ooxml 5.2.5) for Excel export
  - Created ReportExportService with PDF and Excel export methods for:
    - Trial Balance (PDF with balance status, Excel with full formatting)
    - Profit & Loss (PDF with sections, Excel with income/expense breakdowns)
    - Balance Sheet (PDF with assets/liabilities/equity sections, Excel format)
    - Budget vs Actual (PDF landscape format, Excel with variance calculations)
  - Updated ReportsView with export buttons (PDF and Excel) for all report tabs
  - Export buttons appear after generating a report
  - Uses StreamResource and Anchor for browser download functionality
- [x] Global search with query expressions (spec 15)
  - Created GlobalSearchService with query expression parsing
  - Supports filter expressions: type:, status:, amount>, amount<, older_than:, newer_than:
  - Searches across transactions, contacts, products, accounts, invoices, bills
  - All searches are company-scoped for tenant isolation
  - Created GlobalSearchResult DTO with entity-type-specific factory methods
  - Added global search field in MainLayout header
  - Created GlobalSearchView with searchable results grid
  - Results show type, title/subtitle, date, amount, and status with badges
  - Click on result navigates to entity view
  - Search tips help section explains query syntax
  - Added 12 unit tests for query parsing and search behavior
- [x] Saved views (spec 15)
  - Created SavedView entity with columns, filters, sort configuration stored as JSON
  - Supports entity types: TRANSACTION, CONTACT, PRODUCT, ACCOUNT, SALES_INVOICE, SUPPLIER_BILL, RECURRING_TEMPLATE
  - Created V13__saved_views_search.sql migration
  - Created SavedViewRepository and SavedViewService with full CRUD
  - Default view support per entity type per user
  - Audit logging for view creation, update, rename, delete

### Phase 10: Email & Grid Customization (COMPLETE) - Tag: 0.1.8
- [x] Email sending integration (spec 13)
  - Created EmailService with comprehensive email building and validation
  - EmailRequest builder pattern for constructing emails with to/subject/body/attachments
  - EmailResult record for success/failure status tracking
  - Specialized methods: sendInvoice, sendStatement, sendRemittanceAdvice, sendReport
  - Email validation (address format, required fields)
  - v1 stub implementation (logging only, no actual SMTP sending)
  - Configurable via application.properties: moniworks.email.enabled, moniworks.email.from-address, moniworks.email.from-name
  - Audit logging for all email requests
  - 26 unit tests covering all email scenarios
- [x] Grid customization UI (column reorder, show/hide, save views)
  - Created GridCustomizer<T> reusable component for any grid
  - Column visibility toggles via dialog
  - Column reordering via drag-and-drop (grid.setColumnReorderingAllowed)
  - Integration with SavedView entity for persistent column configurations
  - View selector dropdown to switch between saved views
  - Save/Save As buttons for current configuration
  - Manage views dialog for rename/delete/set default
  - Reset to original columns functionality
  - Added column keys and resize support to TransactionsView grid
  - CompanyContextService.getCurrentUser() method added for user context

### Phase 11: Release Readiness & Quality (COMPLETE) - Tag: 0.1.9
- [x] Removed all TODO markers from codebase
  - TransactionsView: 3 TODO markers fixed (posting and attachment user injection)
  - GstReturnsView: 1 TODO marker fixed (tax return generation)
  - SalesInvoicesView: 1 TODO marker fixed (invoice creation)
  - SupplierBillsView: 1 TODO marker fixed (bill creation)
  - Now using companyContextService.getCurrentUser() for proper user attribution
- [x] Added spec 16 (Release Readiness and Quality Gates) documentation
  - Defines Definition of Done (DoD) criteria
  - Quality gates for no TODO/FIXME/XXX markers
  - Test coverage requirements (70% overall, 80% critical)
  - Validation commands and release workflow

### Phase 12: Invoice & Statement PDFs (COMPLETE) - Tag: 0.2.0
- [x] Invoice PDF generation (spec 09, spec 13)
  - Created InvoicePdfService for professional invoice rendering
  - Company header with invoice status (PAID/OVERDUE/ISSUED)
  - Invoice details section (number, dates, reference)
  - Bill To section with customer info
  - Line items table with #, description, qty, price, tax, amount
  - Totals section with subtotal, tax breakdown by code, and total
  - Payment information box with due date
  - PAID stamp for fully paid invoices
  - Notes section and footer
- [x] Add PDF export to SalesInvoicesView
  - Export PDF button for issued invoices (downloads PDF)
  - Email Invoice button (uses EmailService.sendInvoice with dialog)
  - Email dialog with pre-filled recipient, subject, and message
  - StreamResource-based download functionality
- [x] Customer statement generation (spec 09)
  - Created StatementService with open-item statement generation
  - StatementData record with aging buckets (Current, 1-30, 31-60, 61-90, 90+ days)
  - StatementLine record for each outstanding invoice
  - generateStatementData() for statement data
  - generateStatementPdf() for PDF output
  - Aging summary table with colored values for overdue
  - Transaction list with overdue day indicators
  - Payment information box with total due
- [x] AR/AP Aging reports (spec 13)
  - Added generateArAging() to ReportingService
  - Added generateApAging() to ReportingService
  - ArAgingReport record with customer summaries and bucket totals
  - ApAgingReport record with supplier summaries and bucket totals
  - Categorizes by aging buckets: Current, 1-30, 31-60, 61-90, 90+ days
  - Updated ReportingServiceTest with new constructor parameters
  - Statement PDF generation
- [x] AR/AP aging reports UI and export (spec 13)
  - Added AR Aging tab to ReportsView with customer summary grid
  - Added AP Aging tab to ReportsView with supplier summary grid
  - Added exportArAgingToPdf() and exportArAgingToExcel() to ReportExportService
  - Added exportApAgingToPdf() and exportApAgingToExcel() to ReportExportService
  - Aging buckets: Current, 1-30, 31-60, 61-90, 90+ days
  - PDF/Excel export buttons visible after generating reports

### Phase 13a: Receipt Allocation UI (COMPLETE) - Tag: 0.2.2
- [x] Receipt allocation UI in TransactionsView (spec 09)
  - Added "Allocate" button for posted RECEIPT transactions in TransactionsView
  - Created comprehensive allocation dialog showing:
    - Receipt info header (amount, allocated, unallocated)
    - Existing allocations grid with remove capability
    - Outstanding invoices grid with allocation amount fields
    - Auto-allocate button using suggestions (oldest first / exact match)
    - Real-time summary of total being allocated vs remaining
  - ReceivableAllocationService integration for:
    - suggestAllocations() - auto-suggestion based on amount matching
    - getUnallocatedAmount() - track remaining receipt balance
    - allocate() / removeAllocation() - create/remove allocations
- [x] Show payment allocations on invoice detail (spec 09)
  - Added allocations section to SalesInvoicesView invoice detail
  - Shows grid of allocated receipts with date, reference, amount, allocation date
  - Only displays for issued invoices with payments (amountPaid > 0)

### Phase 13b: Payment Allocation UI (COMPLETE) - Tag: 0.2.3
- [x] Payment allocation UI in TransactionsView (spec 10)
  - Added "Allocate" button for posted PAYMENT transactions in TransactionsView
  - Created comprehensive allocation dialog showing:
    - Payment info header (amount, allocated, unallocated)
    - Existing allocations grid with remove capability
    - Outstanding bills grid with allocation amount fields
    - Auto-allocate button using suggestions (oldest first / exact match)
    - Real-time summary of total being allocated vs remaining
  - PayableAllocationService integration for:
    - suggestAllocations() - auto-suggestion based on amount matching
    - getUnallocatedAmount() - track remaining payment balance
    - allocate() / removeAllocation() - create/remove allocations
- [x] Show payment allocations on bill detail (spec 10)
  - Added allocations section to SupplierBillsView bill detail
  - Shows grid of allocated payments with date, reference, amount, allocation date
  - Only displays for posted bills with payments (amountPaid > 0)

### Phase 13c: Statement Runs (COMPLETE) - Tag: 0.2.4
- [x] StatementRun entity and migration (spec 09)
  - Created StatementRun entity with status (PENDING/PROCESSING/COMPLETED/FAILED)
  - Fields: company, runDate, asOfDate, criteriaJson, statementCount, outputAttachmentId
  - Created V14__statement_runs.sql migration
  - Created StatementRunRepository with query methods
- [x] StatementRunService for batch statement processing (spec 09)
  - StatementCriteria record for filtering: minimumBalance, minimumDaysOverdue, contactIds, includeZeroBalance
  - createRun() creates a statement run with criteria stored as JSON
  - processRun() finds matching customers and generates combined PDF
  - previewCustomers() shows which customers would be included before running
  - Combined PDF puts each customer's statement on new pages
  - Audit logging for run creation, completion, and failures
  - Added STATEMENT_RUN to AttachmentLink.EntityType enum

### Phase 13d: Statement Runs UI (COMPLETE) - Tag: 0.2.5
- [x] StatementRunsView UI for batch statement generation (spec 09)
  - Created StatementRunsView with master-detail split layout
  - Grid showing all statement runs with status, date, count, created by
  - Status filter dropdown (PENDING/PROCESSING/COMPLETED/FAILED)
  - Create Statement Run dialog with:
    - As Of Date picker
    - Minimum Balance filter
    - Minimum Days Overdue filter
    - Include Zero Balance checkbox
    - Customer multi-select (optional, for specific customers)
    - Preview button showing which customers will be included
  - Process Now button for pending runs
  - Download PDF button for completed runs
  - Detail panel showing run info, criteria, and status
  - Added Statement Runs navigation to MainLayout with PRINT icon
- [x] User.getDisplayName() used instead of getFullName() (lesson learned)

### Phase 14: SavedView Grid Integration (COMPLETE) - Tag: 0.2.6
- [x] Extend GridCustomizer to additional views (spec 15)
  - Added GridCustomizer to ContactsView with column keys: code, name, type, email, phone, category, status
  - Added GridCustomizer to SalesInvoicesView with column keys: invoiceNumber, customer, issueDate, dueDate, total, balance, status
  - Added GridCustomizer to SupplierBillsView with column keys: billNumber, supplier, billDate, dueDate, total, balance, status
  - Added GridCustomizer to ProductsView with column keys: code, name, category, sellPrice, buyPrice, status
  - Added SavedViewService injection to all updated views
  - Added column resizing support (.setResizable(true)) to all columns
  - GridCustomizer allows users to save custom column layouts per view

### Phase 15: User & Permission Management (COMPLETE) - Tag: 0.2.7
- [x] Method security and permission system (spec 14)
  - Added @EnableMethodSecurity to SecurityConfig to enable method-level security
  - Created CompanyPermissionEvaluator implementing PermissionEvaluator for company-scoped permission checks
  - Created Permissions constants class with compile-time safety for all permission names
  - Created RoleService for role management with CRUD operations
  - Created PermissionService for permission management with role-permission assignments
  - Created V15__additional_permissions.sql migration adding 13 new permissions:
    - VIEW_USERS, MANAGE_USERS, VIEW_ROLES, MANAGE_ROLES
    - MANAGE_COMPANY_SETTINGS, VIEW_AUDIT_LOG, EXPORT_DATA
    - MANAGE_FISCAL_YEARS, CLOSE_PERIODS, REVERSE_TRANSACTIONS
    - MANAGE_BUDGETS, MANAGE_KPIS, MANAGE_RECURRING_TEMPLATES
  - Enhanced CompanyContextService with hasPermission() method for convenient permission checking
- [x] User interface enhancements
  - Added company switcher dropdown to MainLayout header for multi-company users
  - Added user info display and logout button to MainLayout header
  - Created UsersView for user and company membership management (admin only)
  - Added @RolesAllowed("ADMIN") to UsersView for view-level access control
- [x] Repository enhancements
  - Added findByUserIdAndCompanyId to CompanyMembershipRepository for user-company lookups
  - Added findActiveByCompany to CompanyMembershipRepository for active member queries
  - Added findByStatus to UserRepository for status-based user filtering
- [x] Service enhancements
  - Enhanced UserService with membership management methods:
    - addUserToCompany() for adding users to companies with roles
    - removeUserFromCompany() for removing memberships
    - updateMembershipRole() for changing user roles within a company
    - getUserCompanies() for listing all companies a user belongs to

### Phase 16: Cashflow Report & Quality Tooling (COMPLETE) - Tag: 0.2.8
- [x] Cashflow Report (spec 13 - "Cashflow and bank register (basic)")
  - Added generateCashflow() method to ReportingService
  - CashflowStatement record with opening/closing balances, inflows, outflows, net cash flow
  - CashflowAccountSummary record for per-bank-account breakdown
  - CashflowLine record for individual cash movements
  - Calculates opening balance (day before start) and closing balance (end date)
  - Shows reconciliation status (opening + net = closing)
  - Tracks inflows (debits to bank accounts) and outflows (credits from bank accounts)
- [x] Cashflow Report Export (spec 13)
  - Added exportCashflowToPdf() to ReportExportService
  - Added exportCashflowToExcel() to ReportExportService
  - PDF shows cash summary section and per-account breakdown
  - Excel exports with full formatting and formulas
- [x] Cashflow Tab in ReportsView
  - Added "Cashflow" tab with date range selectors
  - Cash summary section with opening, inflows, outflows, net, closing
  - Bank account summary grid with per-account breakdown
  - PDF and Excel export buttons after generating report
- [x] Forbidden Token Scan Script (spec 16 quality tooling)
  - Created scripts/check-forbidden-markers.sh
  - Scans src/main/java and src/test/java for: TODO, FIXME, XXX, HACK, TEMP, WIP, STUB
  - Uses word boundaries to avoid false positives (e.g., RECURRING_TEMPLATE)
  - Returns exit code 1 if markers found (for CI integration)
  - Added to AGENTS.md validation commands

### Phase 17: Account Security Level & Audit Logging (COMPLETE) - Tag: 0.2.9
- [x] UserSecurityLevel entity and migration (spec 02)
  - Created UserSecurityLevel entity with user, company, maxLevel
  - Created V16__user_security_level.sql migration
  - Created UserSecurityLevelRepository with query methods
  - Security levels work hierarchically: level 0 sees unrestricted accounts, level 1+ sees more
  - Admins have unlimited access (Integer.MAX_VALUE security level)
- [x] Account security level filtering in repository queries (spec 02)
  - Added findByCompanyWithSecurityLevel to AccountRepository
  - Added findByCompanyAndActiveWithSecurityLevel
  - Added findRootAccountsByCompanyWithSecurityLevel
  - Added findByParentWithSecurityLevel
  - Added findByCompanyIdAndTypeWithSecurityLevel
  - Added findBankAccountsByCompanyWithSecurityLevel
  - All queries filter out accounts where securityLevel > user's maxLevel
- [x] Security level filtering in AccountService
  - Added findByCompanyWithSecurityLevel method
  - Added findActiveByCompanyWithSecurityLevel method
  - Added findRootAccountsWithSecurityLevel method
  - Added findChildrenWithSecurityLevel method
  - Added findByTypeWithSecurityLevel method
- [x] CompanyContextService security level support (spec 02)
  - Added getCurrentSecurityLevel() method that returns user's max level
  - Admins return Integer.MAX_VALUE to see all accounts
  - Added canViewAccountWithSecurityLevel() helper method
  - Caches security level per session for performance
- [x] Security level filtering in ReportingService (spec 02)
  - Added generateTrialBalance with maxSecurityLevel parameter
  - Added generateProfitAndLoss with maxSecurityLevel parameter
  - Added generateBalanceSheet with maxSecurityLevel parameter
  - Added generateCashflow with maxSecurityLevel parameter
  - Added generateBudgetVsActual with maxSecurityLevel parameter
  - Reports exclude accounts above user's security level
- [x] Dashboard security level filtering (spec 02, spec 13)
  - Cash Balance tile filters bank accounts by security level
  - This Month tile uses security-filtered P&L report
  - Users only see data for accounts they have access to
- [x] Master data edit audit logging (spec 14)
  - AccountService: logs ACCOUNT_CREATED, ACCOUNT_UPDATED with before/after changes, ACCOUNT_DEACTIVATED
  - TaxCodeService: logs TAXCODE_CREATED, TAXCODE_UPDATED with before/after changes, TAXCODE_DEACTIVATED
  - ContactService: logs CONTACT_UPDATED with before/after changes (CREATED and DEACTIVATED already existed)
  - ProductService: logs PRODUCT_UPDATED with before/after changes (CREATED and DEACTIVATED already existed)
  - Changes tracked include: code, name, type, active, and entity-specific fields
- [x] Updated ReportingServiceTest to use new security-filtered mocks

### Phase 18: Report Drilldown & Allocation Rules UI (COMPLETE) - Tag: 0.3.0
- [x] Report drilldown functionality (spec 06, spec 13)
  - Added click-through drilldown from report lines to underlying ledger entries
  - Trial Balance: click row to see ledger entries for that account
  - Profit & Loss: click income/expense row to see ledger entries (supports department filtering)
  - Balance Sheet: click asset/liability/equity row to see ledger entries
  - Budget vs Actual: click row to see ledger entries for that account
  - AR Aging: click customer row to see outstanding invoices
  - AP Aging: click supplier row to see outstanding bills
  - All drilldown dialogs show relevant details and totals
- [x] GST return drilldown (spec 06)
  - Added click-through from GST return boxes to contributing tax lines/transactions
  - Shows tax code, taxable amount, and tax amount for each transaction
  - Total and transaction count displayed
- [x] Allocation Rules Management UI (spec 05, spec 11)
  - Created AllocationRulesView with full CRUD for allocation rules
  - Priority-based rule ordering (higher priority first)
  - Match expression configuration with case-insensitive contains matching
  - Target account and optional tax code assignment
  - Enable/disable rules
  - Test rules feature to verify matching against sample descriptions
  - Audit logging for rule creation, update, and deletion
  - Added navigation to MainLayout with AUTOMATION icon

### Phase 19: Payment Runs UI (COMPLETE) - Tag: 0.3.1
- [x] PaymentRunsView for batch supplier payments (spec 10)
  - Created PaymentRunsView with master-detail split layout
  - Payment run wizard with step-by-step flow:
    - Select bank account and payment date
    - Filter bills by due date and/or specific suppliers
    - Multi-select bills to include in run
    - Preview total and bills grouped by supplier
    - Create draft or create and complete in one step
  - Bills grid showing: bill number, supplier, dates, total, payment amount
  - Summary by supplier showing totals per vendor
  - Actions: Add Bills, Complete Run (for drafts); Download Remittance, Email Remittance (for completed)
  - Remove bills from draft runs
  - Email remittance to suppliers with email addresses configured
  - Added navigation to MainLayout with MONEY_EXCHANGE icon
- [x] Added findBankAccountsByCompany and findBankAccountsByCompanyWithSecurityLevel to AccountService
  - Exposes existing AccountRepository methods for finding bank accounts

### Phase 20: User Invitation Workflow (COMPLETE) - Tag: 0.3.2
- [x] User Invitation entity and migration (spec 02)
  - Created UserInvitation entity with token, expiresAt, status (PENDING/ACCEPTED/EXPIRED/CANCELLED)
  - Fields: email, displayName, company, role, invitedBy, acceptedAt, acceptedUser
  - Created V17__user_invitations.sql migration with indexes
  - Created UserInvitationRepository with query methods for pending/expired invitations
- [x] InvitationService for invitation workflow (spec 02)
  - createInvitation() generates secure token and sends invitation email
  - validateToken() checks if token is valid and not expired
  - acceptInvitationNewUser() creates user account and company membership
  - acceptInvitationExistingUser() creates membership for logged-in users
  - cancelInvitation() and resendInvitation() for admin management
  - @Scheduled task to expire old invitations daily at 3 AM
  - Configurable expiry days (default 7) via moniworks.invitation.expiry-days
  - Configurable base URL via moniworks.invitation.base-url
- [x] AcceptInvitationView (spec 02)
  - Public view (@AnonymousAllowed) for accepting invitations via token
  - Handles new user registration with password setup
  - Handles existing logged-in users accepting invitations
  - Validates email match for existing users
  - Shows invitation details (company, role, expiry, inviter)
  - Redirects to login on success for new users
- [x] UsersView enhancements (spec 02)
  - Added "Invite by Email" button with invitation dialog
  - Added "Pending Invitations" tab showing all company invitations
  - Invitation detail view with resend/cancel/copy link actions
  - Status display and expiry tracking
  - Invitation grid with email, role, status, expires, invited by columns
- [x] InvitationServiceTest with 18 unit tests covering:
  - Create invitation success and failure scenarios
  - Token validation (valid, expired, accepted, nonexistent)
  - Accept invitation for new and existing users
  - Cancel and resend invitation workflows
  - URL generation

### Phase 21: Credit Notes for Invoices (COMPLETE) - Tag: 0.3.3
- [x] Credit Note entity support (spec 09)
  - Added InvoiceType enum (INVOICE, CREDIT_NOTE) to SalesInvoice
  - Added type field and originalInvoice reference to SalesInvoice
  - Created V18__credit_notes.sql migration adding invoice_type and original_invoice_id columns
  - Added helper methods: isCreditNote(), isInvoice() to SalesInvoice entity
- [x] Credit Note service methods (spec 09)
  - Added generateCreditNoteNumber() using CN-{originalNumber} pattern with suffix for multiples
  - Added createCreditNote() to create draft credit note against issued invoice
  - Supports full credit (copies all lines) or partial credit (empty draft for manual entry)
  - Added issueCreditNote() that posts reversed ledger entries:
    - Credit AR control account (reduces receivable)
    - Debit income accounts (reduces income)
    - Debit GST collected (reduces tax liability)
  - Validates credit note amount doesn't exceed invoice remaining balance
  - Credit note total automatically reduces original invoice balance
  - Added findCreditNotesForInvoice() to find all credit notes for an invoice
  - Added findByOriginalInvoice() to SalesInvoiceRepository
- [x] Credit Note UI (spec 09)
  - Added "Credit Note" button on issued invoices in SalesInvoicesView
  - Create Credit Note dialog with full/partial credit options
  - Invoice detail shows "CREDIT NOTE" type badge for credit notes
  - Shows link to original invoice for credit notes
  - Shows list of issued credit notes for invoices
  - Issue button correctly calls issueCreditNote() for credit notes
- [x] SalesInvoiceServiceTest with 11 unit tests covering:
  - Create full credit note success
  - Create partial credit note (empty draft)
  - Cannot create credit note against draft invoice
  - Cannot create credit note against another credit note
  - Second credit note gets incremented suffix
  - Issue credit note posts reversed entries
  - Cannot issue credit note exceeding invoice balance
  - Cannot issue regular invoice as credit note
  - Cannot issue already-issued credit note
  - Cannot issue credit note with no lines
  - Find credit notes for invoice

### Phase 22: Contact CSV Import (COMPLETE) - Tag: 0.3.4
- [x] ContactImportService for CSV parsing (spec 07)
  - Flexible column mapping with case-insensitive header matching
  - Required columns: code, name
  - Optional columns: type, category, email, phone, mobile, website, address fields, paymentTerms, creditLimit, bank details, taxOverrideCode
  - Handles quoted fields with embedded commas
  - Header name normalization (removes spaces, underscores, hyphens)
  - Code length validation (max 11 characters)
  - Credit limit parsing with comma removal
  - Country code truncation to 2 characters
- [x] Import and update modes
  - Import only mode skips existing contacts by code
  - Update mode updates existing contacts with new values
  - Preview mode to see changes before committing
- [x] Import UI in ContactsView
  - "Import CSV" button in toolbar
  - Import dialog with instructions and sample CSV download
  - File upload with CSV format validation
  - Preview of import results before committing
  - "Update existing contacts" checkbox option
  - Error and warning display
- [x] ContactImportServiceTest with 12 unit tests covering:
  - Valid CSV import
  - Missing required columns (code, name)
  - Empty file handling
  - Code length validation
  - Skip existing contacts mode
  - Update existing contacts mode
  - All fields parsing
  - Quoted fields with commas
  - Flexible column name formats
  - Preview mode without saving

### Phase 23: Budget CSV Import (COMPLETE) - Tag: 0.3.5
- [x] BudgetImportService for CSV parsing (spec 12)
  - Flexible column mapping with case-insensitive header matching
  - Required columns: account_code, period_date, amount
  - Optional column: department_code
  - Multiple date format support (YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY, etc.)
  - Amount parsing with comma and dollar sign removal
  - Account code validation against company accounts
  - Period lookup by date (finds period containing the given date)
  - Optional department validation
- [x] Import and update modes
  - Import only mode skips existing budget lines (same account/period/department)
  - Update mode updates existing budget lines with new amounts
  - Preview mode to see changes before committing
- [x] Import UI in BudgetsView
  - "Import CSV" button in budget detail panel
  - Import dialog with instructions and sample CSV download
  - File upload with CSV format validation
  - Preview of import results before committing
  - "Update existing budget lines" checkbox option
  - Error and warning display
- [x] BudgetImportServiceTest with 16 unit tests covering:
  - Valid CSV import
  - Missing required columns
  - Account not found
  - Period not found
  - Invalid date format
  - Invalid amount format
  - Skip existing lines mode
  - Update existing lines mode
  - Department parsing
  - Department not found
  - Multiple date formats
  - Amount with commas and dollar signs
  - Preview mode without saving

### Phase 24: Login Event Tracking (COMPLETE) - Tag: 0.3.6
- [x] AuthenticationEventListener for login events (spec 14)
  - Listens for Spring Security AuthenticationSuccessEvent
  - Logs USER_LOGIN events via AuditService.logLogin()
  - Extracts user from UserDetails or String principal
  - Handles login failure events (LOGIN_FAILED) with attempt details
  - Logs failed login attempts with email and reason
- [x] AuditLogoutHandler for logout events (spec 14)
  - Implements LogoutHandler interface
  - Logs USER_LOGOUT events before session destruction
  - Registered with SecurityFilterChain logout configuration
- [x] SecurityConfig updates
  - Added AuditLogoutHandler to constructor injection
  - Configured logout handler in security filter chain
  - Logout redirects to /login after logging event
- [x] AuthenticationEventListenerTest with 5 unit tests covering:
  - Login success with UserDetails principal
  - Login success with String principal
  - User not found does not log
  - Login failure logs attempt details
  - Null principal logs as unknown
- [x] AuditLogoutHandlerTest with 4 unit tests covering:
  - Logout with UserDetails principal
  - Logout with String principal
  - Null authentication does not log
  - User not found does not log

### Phase 25: Product CSV Import (COMPLETE) - Tag: 0.3.7
- [x] ProductImportService for CSV parsing (follows Contact/Budget import pattern)
  - Flexible column mapping with case-insensitive header matching
  - Required columns: code (max 31 chars), name
  - Optional columns: description, category, buyPrice, sellPrice, taxCode, barcode, stickyNote, salesAccountCode, purchaseAccountCode
  - Handles quoted fields with embedded commas
  - Price parsing with currency symbol ($) and comma removal
  - Account linking by code for salesAccount and purchaseAccount
- [x] Import and update modes
  - Import only mode skips existing products by code
  - Update mode updates existing products with new values
  - Preview mode to see changes before committing
- [x] Import UI in ProductsView
  - "Import CSV" button in toolbar
  - Import dialog with instructions and sample CSV download
  - File upload with CSV format validation
  - Preview of import results before committing
  - "Update existing products" checkbox option
  - Error and warning display
- [x] ProductImportServiceTest with 14 unit tests covering:
  - Valid CSV import
  - Missing required columns (code, name)
  - Empty file handling
  - Code length validation
  - Skip existing products mode
  - Update existing products mode
  - All fields parsing
  - Price with currency symbols and commas
  - Quoted fields with commas
  - Flexible column name formats
  - Account code linking
  - Preview mode without saving
  - Sample CSV content generation

### Phase 26: Role Management UI (COMPLETE) - Tag: 0.3.8
- [x] RolesView for role and permission management (spec 02)
  - Created RolesView with master-detail split layout
  - Grid showing all roles (system and custom) with name, description, type badge, permission count
  - Detail panel showing role info, permissions grouped by category
  - System roles displayed as read-only with view permissions dialog
  - Custom roles can be created, edited, and deleted
- [x] Role CRUD functionality
  - Create Role dialog with name and description fields
  - Edit Role dialog for updating name and description
  - Delete confirmation dialog with warning about user reassignment
  - All operations use existing RoleService with audit logging
- [x] Permission management UI
  - Edit Permissions dialog with all permissions grouped by category
  - Checkboxes for each permission with descriptions
  - Select All/None buttons per category for quick selection
  - View Permissions dialog for system roles (read-only)
- [x] Navigation integration
  - Added RolesView to MainLayout navigation under admin menu (KEY icon)
  - Protected by @RolesAllowed({"ADMIN", "ROLE_ADMIN"}) for admin-only access
  - Visible only to users with MANAGE_USERS permission (alongside Users menu)

### Phase 27: PDF Template Customization (COMPLETE) - Tag: 0.3.9
- [x] PdfSettings domain class (spec 13)
  - Created PdfSettings class for PDF template configuration
  - Logo support via logoAttachmentId reference
  - Company details: companyAddress, companyPhone, companyEmail, companyWebsite, taxId
  - Bank details: bankName, bankAccountNumber, bankAccountName
  - Appearance: footerText, paperSize (A4/Letter/Legal), primaryColor, accentColor (hex)
  - Default values for colors and footer text
- [x] CompanySettings wrapper class
  - Created CompanySettings class as root container for company settings JSON
  - Contains PdfSettings and taxBasis fields
  - getOrCreatePdfSettings() helper for lazy initialization
- [x] CompanyService settings management
  - Added getSettings(Company) to parse settingsJson to CompanySettings
  - Added saveSettings(Company, CompanySettings) to persist settings
  - Added getPdfSettings(Company) convenience method
  - Added savePdfSettings(Company, PdfSettings) convenience method
  - Uses Jackson ObjectMapper for JSON serialization
- [x] InvoicePdfService enhancements
  - Rewrote generateInvoicePdf to accept PdfSettings parameter
  - Configurable logo from attachment storage
  - Dynamic company details from settings
  - Bank payment details for invoices
  - Paper size selection (A4, Letter, Legal)
  - Primary/accent color customization (hex)
  - Customizable footer text
- [x] AttachmentService enhancement
  - Added downloadFile(Long attachmentId) method for easy file retrieval
- [x] CompanySettingsView admin UI (spec 13)
  - Created CompanySettingsView with tabbed interface
  - PDF Settings tab with:
    - Logo upload with preview and remove
    - Company details form (address, phone, email, website, tax ID)
    - Bank details form (bank name, account number, account name)
    - Appearance settings (footer text, paper size, primary/accent colors)
  - Color pickers with hex validation
  - Save button with success notification
  - Added navigation to MainLayout (COG icon) under admin menu
- [x] SalesInvoicesView integration
  - Updated PDF generation to use company PdfSettings
  - Both export and email actions use company-configured settings

### Phase 28: Security Level UI Enforcement (COMPLETE) - Tag: 0.4.0
- [x] Account security level filtering in all views (spec 02, spec 03)
  - AccountsView now uses findByCompanyWithSecurityLevel for account list and parent selector
  - TransactionsView now uses findActiveByCompanyWithSecurityLevel for transaction line accounts
  - BudgetsView now uses findByCompanyWithSecurityLevel for budget line account selector
  - SalesInvoicesView now uses findByTypeWithSecurityLevel for income account selector
  - SupplierBillsView now uses findByTypeWithSecurityLevel for expense account selector
  - BankReconciliationView now uses findActiveByCompanyWithSecurityLevel for allocation accounts
  - ContactsView now uses findActiveByCompanyWithSecurityLevel for default account selector
  - ProductsView now uses findByTypeWithSecurityLevel for sales and purchase accounts
  - AllocationRulesView now uses findActiveByCompanyWithSecurityLevel for target accounts
- [x] User security level management UI (spec 02)
  - Added security level display to user detail panel in UsersView
  - Shows current max security level with explanation
  - "Set Security Level" button opens dialog to configure level
  - Level 0 = basic accounts only, Level 1+ = can view restricted accounts
  - UserSecurityLevelRepository.findByCompanyId() method added for listing all levels
  - Security levels stored in user_security_level table per user-company combination
- [x] All 150 tests passing
- [x] No forbidden markers (TODO/FIXME/etc)


### Phase 29: Bank Register Report (COMPLETE) - Tag: 0.4.1
- [x] Bank Register report in ReportingService (spec 13)
  - BankRegister record with bankAccount, dates, openingBalance, closingBalance, totalDebits, totalCredits
  - BankRegisterLine record with date, reference, description, transactionType, debit, credit, runningBalance, transactionId
  - generateBankRegister() method with security level filtering
  - Calculates opening balance (day before start) and running balance through each transaction
  - isReconciled() verification (opening + debits - credits = closing)
  - netChange() calculation for period
- [x] Bank Register PDF export (spec 13)
  - Landscape A4 format for more columns
  - Company header with account info and date range
  - Reconciliation status indicator
  - Transaction table with debit/credit/running balance columns
  - Summary section with opening, total debits, total credits, net change, closing
  - Color coding for amounts (green for debits/deposits, red for credits/withdrawals)
- [x] Bank Register Excel export (spec 13)
  - Full formatting with headers, data rows, totals
  - Account info and period information
  - Currency formatting for all amounts
- [x] Bank Register tab in ReportsView (spec 13)
  - Bank account selector (security level filtered)
  - Date range pickers with current month defaults
  - Generate Report button
  - Transactions grid with drilldown to transaction ID
  - Opening and closing balance displays
  - PDF/Excel export buttons
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 30: Bank Register Transaction Drilldown (COMPLETE) - Tag: 0.4.2
- [x] Transaction detail drilldown dialog (spec 13 - report drilldown)
  - Added TransactionService injection to ReportsView
  - Created openTransactionDrilldownDialog() method
  - Shows transaction header with type badge, date, status, reference
  - Displays transaction lines grid with account, memo, tax code, debit/credit columns
  - Shows totals row with line count and debit/credit totals
  - Styled consistently with other drilldown dialogs
- [x] Bank Register row click opens transaction dialog
  - Replaced notification-only behavior with full dialog
  - Clicking any row with a transaction ID opens the detail dialog
  - Maintains cursor pointer styling for UX hint
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 31: Tax Basis Settings UI (COMPLETE) - Tag: 0.4.3
- [x] Tax Basis configuration in CompanySettingsView (spec 06)
  - Added new "Tax Settings" tab to CompanySettingsView
  - ComboBox for selecting tax basis (Cash or Invoice/Accrual)
  - Explanatory text for each basis type
  - Saves to CompanySettings.taxBasis field in company settingsJson
  - Works with existing CompanySettings/PdfSettings JSON structure
- [x] GST Returns default basis from company settings (spec 06)
  - Added CompanyService injection to GstReturnsView
  - Generate Return dialog now defaults to company's configured tax basis
  - Falls back to Invoice basis if not configured
  - Users can still override for individual returns
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 32: Tax Default Auto-Population (COMPLETE) - Tag: 0.4.4
- [x] Account default tax code auto-population in TransactionsView (spec 06)
  - Added value change listener to account ComboBox in transaction line entry form
  - When account is selected, automatically populates tax code ComboBox with account's taxDefaultCode
  - Looks up matching TaxCode object from available tax codes list
  - User can still override the auto-populated tax code
  - Improves data entry efficiency by reducing manual tax code selection
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 33: Allocation Rule Auto-Suggest in Manual Entry (COMPLETE) - Tag: 0.4.5
- [x] Allocation rule suggestions in TransactionsView (spec 05, spec 11)
  - Added BankImportService dependency for allocation rule matching
  - When memo field loses focus and account is not yet selected, checks allocation rules
  - Shows suggestion display with matching rule's target account and tax code
  - "Apply" button allows user to accept suggestion, auto-fills account and tax code
  - Suggestion hidden when line is added and form is cleared
  - Uses same findMatchingRule() method as bank reconciliation for consistency
  - Improves manual transaction entry efficiency for recurring payees
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 34: Balance-Forward Statements (COMPLETE) - Tag: 0.4.6
- [x] Balance-forward statement support in StatementService (spec 09)
  - Added StatementType enum (OPEN_ITEM, BALANCE_FORWARD)
  - Created BalanceForwardStatementData record with openingBalance, lines, totalDebits, totalCredits, closingBalance
  - Created BalanceForwardLine record for period activity items (invoices, credit notes, payments)
  - Added ReceivableAllocationRepository dependency for payment lookups in period
  - Added generateBalanceForwardStatementData() method calculating opening balance and period transactions
  - Added generateBalanceForwardStatementPdf() method with opening/activity/closing format
- [x] Repository enhancements for balance-forward queries
  - SalesInvoiceRepository: findByCompanyAndContactAndDateRange for invoices in statement period
  - SalesInvoiceRepository: sumOutstandingByContactAsOfDate for calculating opening balance
  - ReceivableAllocationRepository: findByContactAndDateRange for payments in statement period
- [x] StatementRunService enhancements (spec 09)
  - Extended StatementCriteria with statementType and periodStart fields
  - Added factory methods: openItemCriteria(), balanceForwardCriteria()
  - Updated createRun() JSON serialization for new criteria fields
  - Updated parseCriteria() deserialization
  - Updated processRun() to handle both statement types
  - Added generateCombinedBalanceForwardPdf() for batch balance-forward statements
- [x] StatementRunsView UI enhancements (spec 09)
  - Added Statement Type ComboBox (Open Item / Balance Forward)
  - Added Period Start Date picker (visible only for Balance Forward type)
  - Dynamic field visibility based on statement type selection
  - Validation for required Period Start when Balance Forward selected
  - Updated all buildCriteria calls to pass new parameters
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 35: Contact Tax Override Auto-Population (COMPLETE) - Tag: 0.4.7
- [x] Contact tax override auto-population in SalesInvoicesView (spec 06)
  - When adding invoice lines, if customer has taxOverrideCode set, pre-populates tax code ComboBox
  - Shows helper text "Default from [Contact Name]'s tax override" for transparency
  - Product selection can still override contact default (higher specificity)
  - Implements "Tax defaults by contact" requirement from Spec 06
- [x] Contact tax override auto-population in SupplierBillsView (spec 06)
  - When adding bill lines, if supplier has taxOverrideCode set, pre-populates tax code ComboBox
  - Shows helper text "Default from [Contact Name]'s tax override" for transparency
  - Product selection can still override contact default (higher specificity)
  - Consistent behavior with SalesInvoicesView
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 36: Quality Tooling & Keyboard Shortcuts (COMPLETE) - Tag: 0.4.8
- [x] JaCoCo Code Coverage Plugin (spec 16)
  - Added jacoco-maven-plugin 0.8.12 with prepare-agent, report, and check goals
  - Coverage thresholds: 20% baseline (target 70% overall, 80% services)
  - Coverage reports generated at target/site/jacoco/index.html
  - Threshold progression plan documented in pom.xml for incremental improvement
  - Excludes UI classes from coverage requirements (manually tested)
- [x] Spotless Code Formatting Plugin (spec 16)
  - Added spotless-maven-plugin 2.44.0 with Google Java Format
  - Auto-removes unused imports and orders imports consistently
  - Check with: ./mvnw spotless:check
  - Fix with: ./mvnw spotless:apply
  - All 175 Java files formatted to Google Java Style
- [x] OWASP Dependency-Check Plugin (spec 16)
  - Added dependency-check-maven 10.0.4 for vulnerability scanning
  - Fails build on CVSS score >= 7 (critical vulnerabilities)
  - Suppression file at dependency-check-suppressions.xml
  - Run with: ./mvnw dependency-check:check
- [x] Comprehensive release-check.sh Script (spec 16)
  - Created scripts/release-check.sh with 9-step validation process
  - Steps: git status, forbidden markers, formatting, compilation, tests, coverage, migrations, OWASP, production build
  - --skip-owasp flag for faster local development checks
  - Exit codes indicate pass/fail for CI integration
- [x] Keyboard Shortcuts for Fast Navigation (spec 04, spec 15)
  - Ctrl+K or / - Focus global search (standard web app convention)
  - Alt+P - New Payment transaction
  - Alt+R - New Receipt transaction
  - Alt+J - New Journal transaction
  - Alt+I - New Sales Invoice
  - Alt+B - New Supplier Bill
  - Alt+D - Go to Dashboard
  - Alt+T - Go to Transactions
  - Alt+C - Go to Contacts
  - Alt+O - Go to Reports
  - Alt+A - Go to Accounts
  - ? (Shift+/) - Show keyboard shortcuts help
  - Uses Shortcuts.addShortcutListener() with lifecycle binding to MainLayout
  - TransactionsView, SalesInvoicesView, SupplierBillsView implement BeforeEnterObserver for ?new=true query param
- [x] Updated AGENTS.md with new validation commands
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 37: KPI & Income Trend Charting (COMPLETE) - Tag: 0.4.9
- [x] SparklineChart component (spec 12, spec 13)
  - Created reusable SparklineChart component in ui/components/
  - CSS-based bar chart visualization without external charting library
  - Supports customizable bar color, width, height
  - Supports negative values with baseline positioning
  - Shows labels below bars and optional values above bars
  - Tooltip on hover shows full value
  - Compact number formatting (1.2K, 3.5M)
  - createTrendIndicator() static helper for showing percentage change with arrow
- [x] KPI trend visualization in KPIsView (spec 12 acceptance criteria)
  - Added trend chart section to KPI detail panel
  - Shows sparkline chart of KPI values across fiscal year periods
  - Values sorted chronologically (oldest to newest)
  - Color-coded based on KPI unit type ($ = green, % = primary)
  - Trend indicator comparing latest vs previous period
  - "vs previous period" label with percentage change
- [x] Income Trend dashboard tile (spec 13)
  - New "Income Trend" tile showing income over last 6 months
  - Sparkline visualization of monthly income
  - Trend indicator comparing current month vs previous month
  - Respects user security level for account filtering
- [x] Dashboard now has 6 tiles: Cash Balance, This Month, Income Trend, GST Estimate, Overdue Receivables, Overdue Payables
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 38: Bank Reconciliation Status Report (COMPLETE) - Tag: 0.5.0
- [x] Reconciliation status aggregate queries in BankFeedItemRepository (spec 05, spec 13)
  - countByAccountAndStatus() - count feed items by status per account
  - sumAmountByAccountAndStatus() - sum amounts by status per account
  - findOldestUnmatchedDateByAccount() - find oldest pending item date
  - countByCompanyAndStatus() - company-wide count by status
  - sumAmountByCompanyAndStatus() - company-wide sum by status
- [x] generateReconciliationStatus() in ReportingService
  - ReconciliationStatus record with overall summary statistics
  - ReconciliationAccountSummary record with per-account breakdown
  - Security-level filtering for bank account visibility
  - Calculates reconciled percentage per account and overall
  - Tracks unreconciled amounts and oldest pending dates
- [x] Reconciliation Status tab in ReportsView (spec 05, spec 13)
  - New tab with CHECK_CIRCLE icon in Reports view
  - Summary statistics row showing totals across all accounts
  - Color-coded status boxes (new=blue, matched/created=green, ignored=gray)
  - Grid showing per-account reconciliation details
  - Shows account code, name, counts by status, unreconciled amount, reconciled %
  - Oldest pending date column for identifying stale items
- [x] PDF/Excel export for Reconciliation Status report
  - PDF: Landscape layout with summary table and account details grid
  - PDF: Color-coded reconciled percentage (green=100%, red=<100%)
  - Excel: Summary section with totals plus account details sheet
  - Excel: Percentage formatting for reconciled % column
- [x] All 150 tests passing
- [x] No forbidden markers

### Phase 39: SMTP Email Sending (COMPLETE) - Tag: 0.5.1
- [x] EmailService SMTP integration (spec 13)
  - Updated EmailService to use JavaMailSender for actual email sending
  - Supports text and HTML email bodies
  - Supports multipart messages with PDF attachments
  - Graceful fallback when SMTP not configured (returns queued status for backwards compatibility)
  - Proper error handling for MessagingException and MailException
- [x] SMTP configuration via Spring Boot properties
  - Added spring-boot-starter-mail dependency to pom.xml
  - Documented SMTP configuration in application.properties
  - Example configurations for Gmail, Office 365, and generic SMTP
  - Disabled by default (moniworks.email.enabled=false)
- [x] Backwards compatibility
  - When email disabled: returns DISABLED status (no change)
  - When email enabled but no SMTP configured: returns QUEUED status (stub behavior)
  - When email enabled with SMTP configured: actually sends and returns SENT status
- [x] Test coverage
  - Added tests for SMTP sending success
  - Added tests for SMTP send failure (MailSendException)
  - Added tests for fallback when JavaMailSender not configured
  - Updated all existing tests to use mocked JavaMailSender
- [x] All 152 tests passing (EmailServiceTest: 23)
- [x] No forbidden markers

### Phase 40: Transfer Transactions & Reconciliation Audit Trail (COMPLETE) - Tag: 0.5.2
- [x] Transfer Transaction UI (spec 04)
  - Added Transfer button to TransactionsView toolbar
  - Uses EXCHANGE icon with LUMO_CONTRAST theme
  - Works with existing transaction form dialog
  - Supports Transfer type in type filter dropdown
- [x] Transfer keyboard shortcut (spec 04)
  - Added Alt+X shortcut for new Transfer transaction
  - Updated keyboard shortcuts help dialog to include Transfer
- [x] ReconciliationMatch entity (spec 05)
  - Created ReconciliationMatch entity per spec 05 domain model
  - Tracks bankFeedItemId, transactionId, matchType (AUTO/MANUAL)
  - Includes audit fields: matchedBy, matchedAt, matchNotes
  - Supports unmatching with audit trail (active flag, unmatchedBy, unmatchedAt)
  - Created V19__reconciliation_match.sql migration
  - Created ReconciliationMatchRepository with query methods
- [x] BankImportService ReconciliationMatch integration (spec 05)
  - Updated matchItem() to create ReconciliationMatch record
  - Added overloaded methods for match type and user tracking
  - Added unmatchItem() method with audit trail preservation
  - Added findActiveMatch() and findMatchHistory() methods
- [x] BankReconciliationView audit trail integration (spec 05)
  - Updated match operations to pass current user and match type
  - Both create transaction and match to existing now record audit trail
- [x] LedgerEntry reconciliation status (spec 05)
  - Added ReconciliationStatus enum (UNRECONCILED, RECONCILED, MANUAL_CLEARED)
  - Added reconciliation tracking fields: isReconciled, reconciliationStatus, reconciledBankFeedItem, reconciledAt, reconciledBy
  - Added markReconciled(), markManuallyCleared(), and unreconcile() methods
  - Created V20__ledger_entry_reconciliation.sql migration
  - Added repository queries for unreconciled entries by account
- [x] All 152 tests passing
- [x] No forbidden markers

### Phase 41: Complete Bank Reconciliation Integration (COMPLETE) - Tag: 0.5.3
- [x] LedgerEntry reconciliation integration (spec 05)
  - matchItem() now marks affected LedgerEntry records as reconciled
  - unmatchItem() now unreconciles the LedgerEntry records
  - Ledger entries affecting the bank account are identified and marked
  - Added LedgerEntryRepository dependency to BankImportService
- [x] Unmatch UI in BankReconciliationView (spec 05)
  - Added Unmatch button for matched/created bank feed items
  - Shows matched transaction info in detail panel
  - Added Un-ignore button for ignored items to reset status
  - Detail panel adapts buttons based on item status (NEW, MATCHED, CREATED, IGNORED)
- [x] BankImportService enhancements (spec 05)
  - Added unignoreItem() method to reset ignored items to NEW
  - Enhanced matchItem() with ledger entry reconciliation count logging
  - Enhanced unmatchItem() with ledger entry unreconcile count logging
- [x] All 152 tests passing
- [x] No forbidden markers

### Phase 42: Credit Note Voiding (COMPLETE) - Tag: 0.5.4
- [x] Credit Note void functionality (spec 09)
  - Added voidCreditNote() method to SalesInvoiceService
  - Validates credit note is issued before voiding
  - Creates reversal of posted transaction
  - Restores original invoice's amountPaid (subtracts credit note total)
  - Sets credit note status to VOID
  - Audit logging for CREDIT_NOTE_VOIDED event
- [x] Credit Note void UI (spec 09)
  - Added Void button for issued credit notes in SalesInvoicesView
  - confirmVoidCreditNote() dialog with reason field
  - Fixed confirmVoidInvoice() to use current user instead of null
- [x] Unit tests (4 new tests)
  - voidCreditNote_IssuedCreditNote_VoidsSuccessfully
  - voidCreditNote_NotCreditNote_ThrowsException
  - voidCreditNote_DraftCreditNote_ThrowsException
  - voidCreditNote_NoPostedTransaction_StillVoids
- [x] All 156 tests passing (SalesInvoiceServiceTest: 15)
- [x] No forbidden markers

### Phase 43: Overpayment Support (COMPLETE) - Tag: 0.5.5
- [x] Overpayment support for receipt allocations (spec 09)
  - Removed validation that blocked allocation exceeding invoice balance
  - Overpayments create negative invoice balance (customer credit)
  - Customer credit can be applied to future invoices
  - Updated ReceivableAllocationService documentation
- [x] Overpayment support for payment allocations (spec 10)
  - Removed validation that blocked allocation exceeding bill balance
  - Overpayments create negative bill balance (supplier credit/advance)
  - Supplier credit can be applied against future bills
  - Updated PayableAllocationService documentation
- [x] Unit tests for allocation services (28 new tests)
  - ReceivableAllocationServiceTest: 14 tests covering normal, overpayment, and error cases
  - PayableAllocationServiceTest: 14 tests covering normal, overpayment, and error cases
- [x] All 184 tests passing
- [x] No forbidden markers

### Phase 44: Split Transaction for Bank Reconciliation (COMPLETE) - Tag: 0.5.6
- [x] Split transaction action for bank reconciliation (spec 05)
  - Per spec 05 UX requirements: "Actions: match, split, create transaction, ignore"
  - Added SPLIT status to FeedItemStatus enum in BankFeedItem entity
  - Created SplitAllocation record in BankImportService for holding allocation data
  - Added splitItem() method to BankImportService for creating split transactions
  - Added reconcileSplitTransaction() method for marking ledger entries as reconciled
  - Validates total allocations must equal bank feed item amount
- [x] Split transaction UI in BankReconciliationView
  - Added "Split Across Accounts" button for NEW feed items
  - Dialog allows adding multiple account allocations with amounts and tax codes
  - Real-time display of allocated vs remaining amounts
  - "Split Remaining Evenly" helper button for quick allocation
  - Creates single transaction with bank line plus multiple allocation lines
  - Posts transaction and reconciles ledger entries automatically
- [x] BankImportServiceTest with 13 new tests covering:
  - Split payment with two allocations creates balanced transaction
  - Split receipt with two allocations uses correct debit/credit directions
  - Allocations not matching total throws exception
  - Empty or null allocations throws exception
  - Single allocation works correctly
  - Tax codes are preserved on allocation lines
  - Reconciliation match created with notes
  - SplitAllocation validation (null account, null amount, zero/negative amounts)
  - Reconcile split transaction marks only bank account entries
- [x] All 195 tests passing (BankImportServiceTest: 13)
- [x] No forbidden markers

### Phase 45: Allocation Rule Enhancements (COMPLETE) - Tag: 0.5.7
- [x] Amount range matching for allocation rules (spec 05)
  - Per spec 05: "rules can match on description, amount ranges, counterparty, etc."
  - Added minAmount and maxAmount fields to AllocationRule entity
  - Created V21__allocation_rule_amount_range.sql migration
  - Updated matches() method to support amount range checking (uses absolute value)
  - Both description AND amount must match for rule to apply
- [x] Memo template application
  - Allocation rules now use memoTemplate field (already existed but wasn't being used)
  - Added applyMemoTemplate() method supporting placeholders: {description}, {amount}
  - BankReconciliationView now applies memo template when creating transactions from bank items
- [x] UI enhancements
  - AllocationRulesView now has minAmount and maxAmount fields in the form
  - Test Rules dialog now accepts optional amount for testing amount range rules
  - Updated help text to explain placeholders
- [x] BankImportService enhancements
  - findMatchingRule() now has overloaded version accepting amount parameter
  - BankReconciliationView passes amount for amount-aware rule matching
- [x] AllocationRuleTest with 24 unit tests covering:
  - Description matching (simple contains, CONTAINS keyword, null handling)
  - Amount range matching (min only, max only, range, negative amounts/absolute value)
  - Memo template application (placeholders, null handling)
  - Combined matching scenarios
- [x] All 219 tests passing (AllocationRuleTest: 24)
- [x] No forbidden markers

### Phase 46: Debit Notes for Supplier Bills (COMPLETE) - Tag: 0.5.8
- [x] Debit Note entity support (spec 10)
  - Added BillType enum (BILL, DEBIT_NOTE) to SupplierBill entity
  - Added type field and originalBill reference to SupplierBill
  - Created V22__debit_notes.sql migration adding bill_type and original_bill_id columns
  - Added helper methods: isDebitNote(), isBill() to SupplierBill entity
- [x] Debit Note service methods (spec 10)
  - Added generateDebitNoteNumber() using DN-{originalNumber} pattern with suffix for multiples
  - Added createDebitNote() to create draft debit note against posted bill
  - Supports full debit (copies all lines) or partial debit (empty draft for manual entry)
  - Added postDebitNote() that posts reversed ledger entries:
    - Debit AP control account (reduces payable)
    - Credit expense accounts (reduces expense)
    - Credit GST paid (reduces input tax)
  - Validates debit note amount doesn't exceed bill remaining balance
  - Debit note total automatically reduces original bill balance
  - Added voidDebitNote() method with audit trail
  - Added findDebitNotesForBill() to find all debit notes for a bill
  - Added findByOriginalBill() to SupplierBillRepository
- [x] Debit Note UI (spec 10)
  - Added "Debit Note" button on posted bills in SupplierBillsView
  - Create Debit Note dialog with full/partial debit options
  - Bill detail shows "DEBIT NOTE" type badge for debit notes
  - Shows link to original bill for debit notes
  - Shows list of issued debit notes for bills
  - Post button correctly calls postDebitNote() for debit notes
  - Void button correctly calls voidDebitNote() for debit notes
- [x] SupplierBillServiceTest with 15 unit tests covering:
  - Create full debit note success
  - Create partial debit note (empty draft)
  - Cannot create debit note against draft bill
  - Cannot create debit note against another debit note
  - Second debit note gets incremented suffix
  - Post debit note posts reversed entries
  - Cannot post debit note exceeding bill balance
  - Cannot post regular bill as debit note
  - Cannot post already-posted debit note
  - Cannot post debit note with no lines
  - Find debit notes for bill
  - Void debit note voids successfully
  - Cannot void non-debit-note
  - Cannot void draft debit note
  - Void debit note without posted transaction still voids
- [x] All 234 tests passing (SupplierBillServiceTest: 15)
- [x] No forbidden markers

### Phase 47: Transaction CSV Import (COMPLETE) - Tag: 0.5.9
- [x] TransactionImportService for CSV parsing (follows Contact/Product/Budget import pattern)
  - Flexible column mapping with case-insensitive header matching
  - Required columns: date, type (PAYMENT/RECEIPT/JOURNAL/TRANSFER), description, account_code, amount, direction (DEBIT/CREDIT/DR/CR)
  - Optional columns: reference, tax_code, memo, department_code
  - Multiple date format support (YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY, etc.)
  - Amount parsing with currency symbol ($) and comma removal
  - Direction shorthand support (DR/CR, D/C)
  - Account and department code validation against company data
- [x] Transaction grouping logic
  - Lines with same date + type + description + reference are grouped into one transaction
  - Validates transactions are balanced (debits equal credits)
  - Option to disable grouping for individual line transactions
- [x] Import configuration options
  - Auto-post option to automatically post imported transactions
  - Group by reference option for multi-line transaction grouping
  - Preview mode to see changes before committing
- [x] Import UI in TransactionsView
  - "Import CSV" button in toolbar
  - Import dialog with instructions and sample CSV download
  - File upload with CSV format validation
  - Preview of import results before committing
  - "Auto-post transactions" checkbox option
  - "Group lines by reference" checkbox option
  - Error and warning display
- [x] TransactionImportServiceTest with 21 unit tests covering:
  - Valid CSV import with balanced transaction
  - Missing required columns (date, type, description, account_code, amount, direction)
  - Empty file handling
  - Unbalanced transaction validation
  - Account not found
  - Invalid date format
  - Invalid transaction type
  - Invalid amount format
  - Invalid direction format
  - Tax code and memo parsing
  - Department code parsing and validation
  - Multiple date formats
  - Amount with currency symbols and commas
  - Direction shorthand (DR/CR)
  - Auto-post enabled posts transaction
  - Preview mode without saving
  - Group by reference creates separate transactions
  - Transfer transaction type
  - Sample CSV content generation
- [x] All 255 tests passing (TransactionImportServiceTest: 21)
- [x] No forbidden markers

### Phase 48: Email Statements to Customers (COMPLETE) - Tag: 0.6.0
- [x] Email Statements feature in StatementRunsView (spec 09, spec 13)
  - Added "Email Statements" button for completed statement runs
  - Creates dialog showing customers with email addresses from the run
  - Select/deselect individual customers to email
  - Generates individual statement PDFs per customer using StatementService.generateStatementPdf()
  - Sends emails using existing EmailService.sendStatement() method
  - Tracks sent/failed counts with success/warning notifications
  - Re-calculates customers from run criteria to support email delivery
- [x] Added EmailService and StatementService dependencies to StatementRunsView
- [x] Added parseCriteriaFromRun() method to reconstruct criteria from completed runs
- [x] All 255 tests passing
- [x] No forbidden markers

### Phase 49: Supplier Bill PDF Export (COMPLETE) - Tag: 0.6.1
- [x] BillPdfService for generating supplier bill PDFs (spec 10, spec 13)
  - Professional bill summary documents with company branding
  - Supports both standard bills and debit notes
  - Line items table with description, quantity, unit price, tax, amount
  - Tax breakdown by tax code in totals section
  - Payment status section (PAID stamp, or payment due/overdue status)
  - Notes section and customizable footer
  - Uses PdfSettings for logo, colors, company details (same as invoices)
  - Paper size options: A4, Letter, Legal
- [x] PDF export button in SupplierBillsView (spec 10)
  - "Export PDF" button appears for all posted bills
  - Works for regular bills and debit notes
  - Uses company's PDF settings for consistent branding
  - Downloads PDF directly to browser
- [x] Added BillPdfService and CompanyService dependencies to SupplierBillsView
- [x] All 255 tests passing
- [x] No forbidden markers

### Phase 50: ReversalLink Entity (COMPLETE) - Tag: 0.6.2
- [x] ReversalLink domain entity (spec 04 domain model)
  - Created ReversalLink entity per spec 04: "ReversalLink(originalTransactionId, reversingTransactionId)"
  - Links original transactions to their reversal transactions for formal audit trail
  - Includes: id, originalTransaction, reversingTransaction, createdAt, createdBy, reason
  - Unique constraint on (originalTransactionId, reversingTransactionId) pair
  - Indexes on both foreign keys for query performance
- [x] V23__reversal_link.sql migration
  - Creates reversal_link table with foreign keys to transaction table
  - Adds indexes and unique constraint
- [x] ReversalLinkRepository with query methods
  - findByOriginalTransaction() - find reversal of a transaction
  - findByReversingTransaction() - find what transaction this reversal reversed
  - existsByOriginalTransaction() - check if transaction has been reversed
  - existsByReversingTransaction() - check if transaction is a reversal
- [x] PostingService integration
  - Updated reverseTransaction() to create ReversalLink when reversing
  - Added isReversed() method to check if transaction was reversed
  - Added isReversal() method to check if transaction is a reversal
  - Added findReversalLink() and findOriginalLink() helper methods
- [x] PostingServiceTest updated with ReversalLinkRepository mock
  - Verifies ReversalLink is created when reversing a transaction
- [x] All 255 tests passing
- [x] No forbidden markers

## Lessons Learned
- VaadinWebSecurity deprecated in Vaadin 24.8+ - use VaadinSecurityConfigurer.vaadin() instead
- Test profile should use hibernate.ddl-auto=create-drop with Flyway disabled to avoid schema conflicts
- AuditService should create its own ObjectMapper rather than injecting as bean for test isolation
- TreeGrid requires TreeDataProvider with proper parent-child hierarchy setup
- @VaadinSessionScope for session-scoped beans (like CompanyContextService)
- When adding new dependencies to PostingService (like TaxCalculationService), update unit tests to include mocks
- Vaadin 25+ deprecates MemoryBuffer and StreamResource - functionality still works but will need update in future versions
- File attachments stored outside DB with checksums for integrity; deduplication by checksum within company scope
- AuditService.logEvent requires User parameter (can be null for system actions)
- AccountService.findByType takes companyId (Long), not Company object
- REGEXP is not supported in HQL/JPQL - use application-side filtering for regex-like matching
- TransactionService.createTransaction requires description parameter
- OpenPDF (com.github.librepdf:openpdf) used for PDF generation - provides Document, PdfWriter, PdfPTable classes
- When adding new services that need circular dependencies (like RemittanceAdviceService in PaymentRunService), ensure constructor injection order
- FiscalYear uses getLabel() not getName() - Period uses getStartDate()/getEndDate() without getName()
- Use DateTimeFormatter for displaying period names (e.g., "MMM yyyy")
- AccountService.findByCompany takes Company object, not companyId
- When adding new constructor parameters to services (like ReportingService), update all unit tests to include mocks for the new dependencies
- H2 reserves 'value' as a keyword - renamed kpi_value.value to metric_value via migration V11
- AuditService.logEvent signature: (Company, User, String eventType, String entityType, Long entityId, String summary) - use strings not enums
- @Scheduled annotation requires Spring's scheduling to be enabled (@EnableScheduling on Application class)
- JSON payload serialization for recurring templates uses Jackson ObjectMapper with ObjectNode/ArrayNode builders
- When using both OpenPDF and Apache POI, fully qualify Row/Cell/Font classes to avoid ambiguity (use org.apache.poi.ss.usermodel.Row, etc.)
- Apache POI (poi-ooxml) used for Excel export - provides XSSFWorkbook for .xlsx format
- StreamResource with Anchor and download attribute creates browser download functionality in Vaadin
- LumoUtility.FontStyle may not be available in all Vaadin versions - use inline style instead: element.getStyle().set("font-style", "italic")
- When creating Vaadin views with listeners referencing other UI components, ensure those components are initialized before the listener is defined to avoid "variable might not have been initialized" errors
- TransactionLine uses amount/direction (DEBIT/CREDIT) pattern, not separate debitAmount/creditAmount fields
- SalesInvoiceRepository uses findByCompanyOrderByIssueDateDescInvoiceNumberDesc, SupplierBillRepository uses findByCompanyOrderByBillDateDescBillNumberDesc
- SalesInvoice uses getTotal() not getTotalAmount() for the invoice total
- Vaadin TextField uses setAutoselect(true) instead of selectAll() method
- GridCustomizer requires column keys (.setKey()) to be set on grid columns for customization to work
- CompanyContextService.getCurrentUser() uses SecurityContextHolder to get authenticated user
- When adding new constructor parameters to services (like ReportingService AR/AP repos), must update unit tests
- Statement generation uses findOutstandingByCompanyAndContact which filters by balance > 0 already
- AR/AP Aging reports categorize by days overdue using ChronoUnit.DAYS.between(dueDate, asOfDate)
- Vaadin Grid Column does not have setClassNameGenerator() method - use Grid.setClassNameGenerator() on the grid instead
- User entity uses getDisplayName() not getFullName() for user's display name
- SecurityConfig with @EnableMethodSecurity requires a MethodSecurityExpressionHandler bean with custom PermissionEvaluator
- Company-scoped permission checks use CompanyPermissionEvaluator.hasCompanyPermission() via @PreAuthorize
- Vaadin views can use @RolesAllowed for role-based access control at the view level
- CompanyContextService.hasPermission() provides convenient permission checking in UI components
- AccountRepository now has security-level filtered variants of all queries - use WithSecurityLevel suffix methods when user context matters
- AuditService.logEvent with changes Map parameter serializes before/after values to detailsJson for tracking field changes
- Grid addItemClickListener() enables drilldown functionality - combine with cursor pointer styling for UX hint
- Vaadin Checkbox doesn't have setUserData/getUserData methods - use a Map<Checkbox, Object> to associate data with checkboxes
- EmailService.EmailResult.queued() is a static factory method, not an instance method - check status with result.status().equals("QUEUED")
- EmailService.sendRemittanceAdvice signature is (Contact, Company, byte[], User) - contact first, not company
- User invitation tokens use SecureRandom with Base64 URL encoding for security
- Vaadin @AnonymousAllowed annotation allows public access to views without Spring Security config changes
- ReflectionTestUtils.setField() used to inject @Value fields in unit tests
- Spring Security @EventListener with AuthenticationSuccessEvent/AbstractAuthenticationFailureEvent provides login event tracking
- LogoutHandler interface allows audit logging before session is destroyed during logout
- Account security level filtering must be applied in ALL views that display account selectors - use companyContextService.getCurrentSecurityLevel() and the WithSecurityLevel service methods
- UserSecurityLevelRepository can be injected directly into views for simple CRUD operations without needing a dedicated service
- Bank Register report is separate from Cashflow report - Cashflow aggregates all bank accounts, Bank Register shows transaction-level detail per account with running balance
- ReportsView tabs pattern: create tab layout method returning VerticalLayout, create load method, create display method, create update export buttons method
- Transaction.Status enum (not TransactionStatus) - access as Transaction.Status.POSTED
- TransactionLine.taxCode is a String not TaxCode object - display directly without .getCode()
- Contact.taxOverrideCode is used to pre-populate tax codes in invoice/bill line entry; product tax code takes precedence when product selected
- Vaadin 25 keyboard shortcuts use Shortcuts.addShortcutListener(component, command, key, modifiers) with component as lifecycle owner - NOT ShortcutRegistration.setLifecycleOwner() which is private
- Views can handle query parameters via BeforeEnterObserver.beforeEnter() with event.getLocation().getQueryParameters()
- Google Java Format via Spotless changes all existing code formatting - run spotless:apply before committing formatted changes
- Vaadin Charts requires commercial license; for open source use SparklineChart component (CSS-based) or ApexCharts-flow addon (Apache 2.0 licensed, but may need version matching for Vaadin 25)
- SparklineChart provides lightweight charting without external dependencies using CSS flexbox and styled divs
- JavaMailSender can be injected with @Autowired(required = false) to gracefully handle missing SMTP configuration
- MimeMessage with MimeMultipart supports text/HTML body plus PDF attachments via ByteArrayDataSource and DataHandler
- Spring Boot auto-configures JavaMailSender bean when spring.mail.* properties are set and spring-boot-starter-mail is on classpath
- ReconciliationMatch entity provides audit trail for bank reconciliation - stores who matched what, when, and how (AUTO vs MANUAL); keeps inactive records for audit history
- LedgerEntry reconciliation status is operational metadata (mutable) separate from immutable accounting data; use ReconciliationStatus enum
- BankImportService.matchItem() has overloaded versions: (item, transaction) for legacy compatibility, (item, transaction, user) for manual with audit, (item, transaction, matchType, user) for full control
- Account.setBankAccount(boolean) not setIsBankAccount(); Transaction.setTransactionDate(LocalDate) not setDate()
- Overpayment handling: ReceivableAllocationService and PayableAllocationService allow allocations exceeding invoice/bill balance - creates negative balance (customer/supplier credit)
- Split transaction pattern: Use Java records for validated DTOs (SplitAllocation), with Objects.requireNonNull and validation in compact constructor; BankFeedItem.SPLIT status is separate from MATCHED/CREATED to distinguish split allocations
- AllocationRule.matches() now has overloaded version matches(description, amount) that checks both description and amount range; uses absolute value for amount comparison to handle both inflows and outflows
- Debit notes for supplier bills mirror credit notes for invoices: BillType.DEBIT_NOTE uses DN- prefix, originalBill reference, reversed journal entries (DR AP, CR Expense, CR GST Paid)
- Transaction CSV import groups lines by date + type + description + reference combination; each unique combo becomes one transaction. Validates balanced entries (debits = credits) before creating transactions.
- StatementRunService.previewCustomers() can be reused for email dialog to get list of customers matching run criteria; parseCriteriaFromRun() pattern parses JSON back to StatementCriteria for completed runs
- BillPdfService mirrors InvoicePdfService pattern: same fonts, colors, layout structure, and PdfSettings support for consistent PDF generation across AR and AP documents
- ReversalLink entity formally tracks reversal relationships between transactions per spec 04 domain model; string-based "REV-" reference tracking in description is kept for backwards compatibility and quick visual identification

## Technical Notes
- Build: `./mvnw compile`
- Test: `./mvnw test`
- Run: `./mvnw spring-boot:run` (starts on http://localhost:8080)
- Package: `./mvnw package -Pproduction`
- Run with production profile: `java -jar target/moniworks-1.0-SNAPSHOT.jar --spring.profiles.active=prod`
- mvnw needs `chmod +x` after clone
- H2 console available in dev mode at http://localhost:8080/h2-console

## Architecture Decisions
- Money stored as BigDecimal with 2 decimal places (minor units)
- Dates: LocalDate for accounting, Instant for audit timestamps
- Ledger entries are immutable - corrections via reversals only
- Multi-tenant: All entities include companyId, enforced in queries
- Session-scoped CompanyContextService manages current company per user session
- Tax calculation assumes tax-inclusive amounts (NZ standard) - extracts GST from totals
- TaxLine records created during posting for audit trail and return generation
- Attachments stored on filesystem with path: {storagePath}/{companyId}/{year}/{month}/{uuid}_{sanitizedFilename}
- Attachment deduplication by SHA-256 checksum within company scope (avoids storing same file twice)
- Audit events are append-only and immutable - no delete capability exposed in UI
- Contacts support CUSTOMER, SUPPLIER, or BOTH types for flexible use in A/R and A/P
- Products have separate sales and purchase accounts for proper P&L allocation
